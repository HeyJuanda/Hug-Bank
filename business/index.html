<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../bank.png" />
    <title>Hug-Bank! • Business</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --hug-primary: #007bff;
            --hug-secondary: #f3f4f6;
            --hug-text-color: #1f2937;
            --hug-header: #3b82f6;
            --hug-danger: #dc3545;
        }
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacs, sans-serif;
            background-color: var(--hug-secondary);
            color: var(--hug-text-color);
        }
        .bg-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: var(--hug-primary);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-danger {
            background-color: var(--hug-danger);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .product-card {
             cursor: pointer;
             transition: all 0.2s ease;
             border: 2px solid transparent;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--hug-primary);
        }
        input[type="text"][id="product-emoji"], input[type="text"][id="edit-product-emoji"] {
            font-size: 1.5rem;
            text-align: center;
        }
        
        /* Estilo para las opciones múltiples (Radio Buttons) */
        .radio-option {
            display: none;
        }
        .radio-label {
            display: block;
            padding: 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #e5e7eb;
            font-weight: 600;
        }
        .radio-label:hover {
            border-color: #93c5fd; /* blue-300 */
        }
        .radio-option:checked + .radio-label {
            background-color: #eff6ff; /* blue-50 */
            border-color: var(--hug-primary); /* blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 md:p-8">

    <div id="app" class="w-full max-w-5xl">
        
    <div id="business-login" class="hidden bg-card p-6 md:p-8 max-w-lg mx-auto">
            <h2 class="text-3xl font-bold mb-6 text-center text-hug-header">
                 <img src="../bank.svg" alt="Logo" class="inline h-10 w-10 mr-2 align-middle">
                 Acceso de Negocio
            </h2>
            <form id="business-login-form" class="space-y-4">
                 <p class="text-center text-lg font-medium">Inicia sesión con tu cuenta HUG Bank</p>
                <div>
                    <label for="business-email" class="block text-sm font-medium">Correo Electrónico del Negocio</label>
                    <input type="email" id="business-email" required placeholder="negocio@ejemplo.com"
                           class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="business-password" class="block text-sm font-medium">Contraseña</label>
                    <input type="password" id="business-password" required placeholder="********"
                           class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full py-3 px-4 rounded-full text-lg font-semibold text-white btn-primary">
                    Ingresar al POS
                </button>
            </form>
        </div>
        
    <div id="charge-setup" class="bg-card p-0 md:p-0">
            <div class="p-4 md:p-6 border-b flex justify-between items-center">
                 <div>
                    <h2 class="text-2xl font-bold text-hug-header">Punto de Venta</h2>
                    <p class="text-sm">Bienvenido, <span id="business-name-display" class="font-bold"></span></p>
                 </div>
                 <div class="flex space-x-2">
                    <button onclick="window.location.href='../'" class="py-1 px-3 rounded-full text-sm font-semibold text-white bg-blue-500 hover:bg-blue-700">
                        ↩
                    </button>
                    <button id="toggle-statistics-btn" class="py-1 px-3 rounded-full text-sm font-semibold text-white bg-blue-500 hover:bg-blue-700">
                        Estadísticas
                    </button>
                    <button id="business-logout-btn" class="py-1 px-3 rounded-full text-sm font-semibold text-white bg-gray-500 hover:bg-gray-700">
                        Cerrar Sesión
                    </button>
                 </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-5 min-h-[500px]">
                
                <div class="md:col-span-3 p-4 md:p-6 border-r flex flex-col">
                    <div id="dynamic-pos-panel" class="flex-grow flex flex-col relative">
                        
                        <div id="edit-product-modal" class="absolute inset-0 bg-white bg-opacity-95 z-20 p-6 md:p-8 hidden">
                            <h3 class="text-2xl font-bold mb-6 text-center text-hug-header">Editar Producto</h3>
                            <form id="edit-product-form" class="space-y-4 max-w-sm mx-auto bg-card p-6 shadow-xl">
                                <input type="hidden" id="edit-product-index">
                                
                                <div class="grid grid-cols-6 gap-3">
                                     <div class="col-span-1">
                                         <label for="edit-product-emoji" class="block text-sm font-medium">Emoji</label>
                                         <input type="text" id="edit-product-emoji" maxlength="2" required
                                               class="mt-1 block w-full px-1 py-1 border rounded-lg focus:ring-blue-500 focus:border-blue-500 text-3xl text-center">
                                     </div>
                                     <div class="col-span-5">
                                         <label for="edit-product-name" class="block text-sm font-medium">Nombre</label>
                                         <input type="text" id="edit-product-name" required placeholder="Nombre del Producto"
                                               class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                     </div>
                                </div>
                                
                                <div>
                                     <label for="edit-product-price" class="block text-sm font-medium">Precio ($)</label>
                                     <input type="number" id="edit-product-price" required min="0.01" step="0.01" placeholder="9.99"
                                           class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                </div>

                      <div>
                         <label for="edit-product-cost" class="block text-sm font-medium">Costo ($)</label>
                         <input type="number" id="edit-product-cost" required min="0" step="0.01" placeholder="1.50"
                             class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                      </div>

                                <button type="submit" class="w-full py-3 px-4 rounded-full text-lg font-semibold text-white btn-primary">
                                    Guardar Cambios
                                </button>
                                <button type="button" id="cancel-edit-btn" class="w-full py-2 px-4 rounded-full text-sm font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300">
                                    Cancelar Edición
                                </button>
                            </form>
                        </div>
                        <div id="product-catalog-view"> 
                            <h3 class="text-xl font-semibold mb-3 flex justify-between items-center">
                                Catálogo de Productos
                                <button id="toggle-add-product-form-btn" class="text-white bg-green-500 hover:bg-green-600 rounded-full w-8 h-8 flex items-center justify-center text-2xl leading-none shadow-md" title="Añadir Producto">
                                    +
                                </button>
                            </h3>
        
                            <form id="add-product-form" class="space-y-3 p-4 border rounded-lg bg-gray-50 mb-4 hidden">
                                 <p class="text-sm font-medium">Añadir y Guardar Producto al Catálogo:</p>
                                <div class="grid grid-cols-6 gap-3">
                                    <div class="col-span-1">
                                         <label for="product-emoji" class="block text-xs font-medium">Emoji</label>
                                         <input type="text" id="product-emoji" maxlength="2" required placeholder="❔"
                                               class="mt-1 block w-full px-1 py-1 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div class="col-span-3">
                                         <label for="product-name" class="block text-xs font-medium">Nombre</label>
                                         <input type="text" id="product-name" required placeholder="Ej: Café Latte"
                                               class="mt-1 block w-full px-3 py-1 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div class="col-span-2">
                                         <label for="product-price" class="block text-xs font-medium">Precio ($)</label>
                                         <input type="number" id="product-price" required min="0.01" step="0.01" placeholder="3.99"
                                               class="mt-1 block w-full px-3 py-1 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                        <div class="col-span-2">
                             <label for="product-cost" class="block text-xs font-medium">Costo ($)</label>
                             <input type="number" id="product-cost" required min="0" step="0.01" placeholder="1.00"
                                 class="mt-1 block w-full px-3 py-1 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                                </div>
                                <button type="submit" class="w-full py-2 px-4 rounded-full text-sm font-semibold text-white btn-primary">
                                    Añadir y Guardar
                                </button>
                            </form>
        
                            <div id="product-list" class="grid grid-cols-2 lg:grid-cols-3 gap-3 overflow-y-auto flex-grow pr-1">
                                <p class="col-span-3 text-center text-gray-500" id="empty-catalog-message">Cargando catálogo o vacío. Use el botón (+) para añadir.</p>
                            </div>
                        </div>

                        <div id="payment-method-view" class="hidden flex-grow flex flex-col justify-between">
                            <div class="p-0 text-center">
                                <h2 class="text-2xl font-bold mb-2">
                                    Monto a Pagar: <span id="display-charge-amount-payment-method" class="text-hug-danger">$0.00</span>
                                </h2>
                                <p class="text-lg font-medium mb-4">Paso 2: Seleccionar Método de Pago</p>
                                
                                <div class="mb-6 text-left">
                                    <label for="transaction-description" class="block text-sm font-medium text-gray-700">Descripción de la Transacción (Opcional)</label>
                                    <input type="text" id="transaction-description" placeholder="Ej: Venta de café y postre"
                                           class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <form id="payment-options-form" class="space-y-4">
                                    
                                    <input type="radio" id="option-hug-bank" name="payment-option" value="hug-bank" class="radio-option">
                                    <label for="option-hug-bank" class="radio-label bg-white hover:bg-gray-50 flex justify-between items-center">
                                        <span>1. Pagar con HUG-Bank!</span>
                                        <span class="text-2xl text-blue-500">💳</span>
                                    </label>

                                    <input type="radio" id="option-cash" name="payment-option" value="cash" class="radio-option">
                                    <label for="option-cash" class="radio-label bg-white hover:bg-gray-50 flex justify-between items-center">
                                        <span>2. Pagar con Efectivo</span>
                                        <span class="text-2xl text-green-600">💵</span>
                                    </label>
                                    
                                    </form>
                            </div>
                            <div class="mt-auto">
                                <button id="cancel-payment-selection-btn" class="w-full mt-6 py-3 px-4 rounded-full text-lg font-semibold btn-danger">
                                    Cancelar Transacción
                                </button>
                            </div>
                        </div>

                        <div id="customer-login-view" class="hidden flex-grow flex flex-col justify-center">
                            <div class="max-w-md mx-auto w-full">
                                <h2 class="text-2xl font-bold mb-2 text-center">
                                    Monto a Pagar: <span id="display-charge-amount-login" class="text-hug-danger">$0.00</span>
                                </h2>
                                <p class="text-center text-lg font-medium mb-6">Paso 3: Cliente debe Iniciar Sesión (HUG Bank)</p>
            
                                <form id="customer-login-form" class="space-y-4">
                                    <div>
                                        <label for="customer-email" class="block text-sm font-medium">Correo Electrónico del Cliente</label>
                                        <input type="email" id="customer-email" required placeholder="tu.correo@ejemplo.com"
                                               class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label for="customer-password" class="block text-sm font-medium">Contraseña del Cliente</label>
                                        <input type="password" id="customer-password" required placeholder="********"
                                               class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <button type="submit" class="w-full py-3 px-4 rounded-full text-lg font-semibold text-white btn-primary">
                                        Continuar al Pago
                                    </button>
                                </form>
                                <button id="cancel-login-btn" class="w-full mt-4 py-3 px-4 rounded-full text-lg font-semibold btn-danger">
                                    Cancelar Transacción
                                </button>
                            </div>
                        </div>

                        <div id="payment-confirmation-view" class="hidden flex-grow flex flex-col justify-center text-center">
                             <div class="max-w-md mx-auto w-full">
                                <h2 class="text-3xl font-extrabold mb-4 text-hug-header">Confirmación de Pago</h2>
            
                                 <div class="bg-blue-50 p-6 rounded-xl border border-blue-200 mb-6">
                                    <p class="text-sm text-blue-600">Total a Cobrar</p>
                                    <h3 class="text-5xl font-extrabold mt-1" id="display-charge-amount-confirm">$0.00</h3>
                                    <p class="text-sm text-blue-600 mt-2">Tu Saldo Actual: <span id="display-current-balance" class="font-bold">$0.00</span></p>
                                 </div>
                                 
                                 <p class="mb-6 text-lg">Paso 4: Aprobar el Pago por <span id="customer-name-display" class="font-bold">Cliente</span></p>
            
                                <button id="confirm-payment-btn" class="w-full py-3 px-4 rounded-full text-lg font-semibold text-white btn-primary">
                                    Aprobar Pago
                                </button>
                                <button id="cancel-payment-btn" class="w-full mt-4 py-3 px-4 rounded-full text-lg font-semibold btn-danger">
                                    Cancelar Transacción
                                </button>
                             </div>
                        </div>
                        
                        <div id="transaction-complete-view" class="hidden flex-grow flex flex-col justify-center text-center">
                             <div class="max-w-md mx-auto w-full">
                                <div id="complete-icon" class="text-6xl mb-4"></div>
                                <h2 id="complete-title" class="text-3xl font-bold mb-2"></h2>
                                <p id="complete-message" class="mb-8 text-gray-600"></p>
                                
                                <h3 class="text-xl font-bold mb-4">Listo para el Siguiente Cliente</h3>
            
                                <button id="new-transaction-btn" class="w-full py-3 px-4 rounded-full text-lg font-semibold text-white btn-primary">
                                    Iniciar Nueva Transacción
                                </button>
                             </div>
                        </div>
                        
                        <div id="statistics-view" class="hidden flex-grow flex flex-col">
                             <h3 class="text-xl font-semibold mb-3">Estadísticas de Ventas</h3>
                             
                             <div class="mb-4 flex items-center space-x-3">
                                <label for="stats-period-selector" class="text-sm font-medium">Periodo:</label>
                                <select id="stats-period-selector" class="px-3 py-1 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <option value="daily">Día Actual</option>
                                    <option value="monthly">Mes Actual</option>
                                    <option value="yearly">Año Actual</option>
                                    <option value="total" selected>Total</option>
                                </select>
                                <button id="refresh-stats-btn" class="py-1 px-3 rounded-lg text-sm font-semibold text-white bg-green-500 hover:bg-green-700">
                                    Actualizar
                                </button>
                             </div>
                             
                             <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                     <p class="text-sm font-medium text-blue-600">Ingreso Total</p>
                                     <h4 id="total-revenue-display" class="text-3xl font-bold text-blue-800">$0.00</h4>
                                </div>
                          <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                              <p class="text-sm font-medium text-green-600">Productos Vendidos</p>
                              <h4 id="total-items-display" class="text-3xl font-bold text-green-800">0</h4>
                          </div>
                          <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                              <p class="text-sm font-medium text-yellow-700">Costo Total</p>
                              <h4 id="total-cost-display" class="text-3xl font-bold text-yellow-800">$0.00</h4>
                          </div>
                          <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                              <p class="text-sm font-medium text-indigo-600">Ganancia Estimada</p>
                              <h4 id="total-profit-display" class="text-3xl font-bold text-indigo-800">$0.00</h4>
                          </div>
                             </div>
                             
                             <h4 class="text-lg font-semibold mb-2 mt-2 border-t pt-4">Productos Más Vendidos</h4>
                             
                             <div id="top-products-list" class="space-y-3 overflow-y-auto flex-grow pr-1">
                                <p class="text-center text-gray-500" id="empty-stats-message">Seleccione un periodo y actualice.</p>
                             </div>

                             <button id="back-to-pos-btn" class="w-full mt-4 py-2 px-4 rounded-full text-sm font-semibold text-white bg-gray-500 hover:bg-gray-700">
                                Volver al Punto de Venta
                            </button>
                        </div>
                        </div>
                </div>
                <div class="md:col-span-2 p-4 md:p-6 flex flex-col border-t md:border-t-0">
                    <h3 class="text-xl font-semibold mb-3">Total y Carrito</h3>
                    
                    <div id="cart-items" class="space-y-2 max-h-60 overflow-y-auto p-2 border rounded-lg bg-white flex-grow mb-4">
                        <p class="text-gray-500 text-center" id="empty-cart-message">Seleccione productos en la izquierda.</p>
                    </div>
                    
                    <div class="flex justify-between items-center font-bold text-2xl pt-4 border-t mt-auto">
                        <span>Total:</span>
                        <span id="display-total-amount" class="text-hug-danger">$0.00</span>
                    </div>
                    
                    <div class="mt-4 space-y-3">
                        <button id="checkout-btn" class="w-full py-3 px-4 rounded-full text-lg font-semibold text-white btn-primary" disabled>
                            Proceder al Pago
                        </button>
                        <button id="clear-cart-btn" class="w-full py-2 px-4 rounded-full text-sm font-semibold text-white bg-gray-400 hover:bg-gray-600">
                            Vaciar Carrito
                        </button>
                    </div>
                </div>
                </div>
        </div>

        <div id="message-box" class="mt-4 p-4 rounded-lg text-sm hidden" role="alert"></div>

    </div>
    
    <script type="module">
        // IMPORTACIONES DE FIREBASE
        // Se añade 'where' a las importaciones
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, runTransaction, collection, addDoc, serverTimestamp, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE (DEMO CONFIG) ---
        const demoFirebaseConfig = {
            apiKey: "AIzaSyBedGoV0Lp_i0Z2wo1_0SkaJa_NrZTPN2g",
            authDomain: "hug-bank.firebaseapp.com",
            projectId: "hug-bank",
            storageBucket: "hug-bank.firebasestorage.app",
            messagingSenderId: "891285624181",
            appId: "1:891285624181:web:c37e3a50275353af88af3c",
            measurementId: "G-5HDSRH2SB2"
        };
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : demoFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); // Para negocio
    const db = getFirestore(app);

    // Instancia secundaria para el cliente
    const clientApp = initializeApp(firebaseConfig, 'client');
    const clientAuth = getAuth(clientApp);

    // Variables de sesión
    let businessUser = null; 
    let cart = []; 
    let totalAmount = 0; 
    let paymentMethod = null; 
    let productCatalog = []; 
    let transactionDescription = '';
    let clientUser = null;
        
        // --- REFERENCIAS DE UI ---
        const messageBox = document.getElementById('message-box');
        const businessLoginForm = document.getElementById('business-login-form');
        const addProductForm = document.getElementById('add-product-form'); 
        const toggleAddProductFormBtn = document.getElementById('toggle-add-product-form-btn'); 
        const checkoutBtn = document.getElementById('checkout-btn'); 
        const clearCartBtn = document.getElementById('clear-cart-btn'); 
        const businessLogoutBtn = document.getElementById('business-logout-btn');
        const productList = document.getElementById('product-list'); 
        const cartItemsContainer = document.getElementById('cart-items'); 
        const displayTotalAmount = document.getElementById('display-total-amount'); 
        
        // Referencias de Edición (NUEVAS)
        const editProductModal = document.getElementById('edit-product-modal');
        const editProductForm = document.getElementById('edit-product-form');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editProductIndexInput = document.getElementById('edit-product-index');
        const editProductNameInput = document.getElementById('edit-product-name');
        const editProductEmojiInput = document.getElementById('edit-product-emoji');
        const editProductPriceInput = document.getElementById('edit-product-price');
    const editProductCostInput = document.getElementById('edit-product-cost');

        // Referencias del nuevo flujo de Vistas
        const paymentMethodView = document.getElementById('payment-method-view');
        const customerLoginView = document.getElementById('customer-login-view');
        const paymentConfirmationView = document.getElementById('payment-confirmation-view');
        const transactionCompleteView = document.getElementById('transaction-complete-view');
        const productCatalogView = document.getElementById('product-catalog-view');
        
        // Referencias de la nueva vista de estadísticas
        const statisticsView = document.getElementById('statistics-view'); 
        const toggleStatisticsBtn = document.getElementById('toggle-statistics-btn');
        const backToPosBtn = document.getElementById('back-to-pos-btn');
        const totalRevenueDisplay = document.getElementById('total-revenue-display');
        const totalItemsDisplay = document.getElementById('total-items-display');
        const topProductsList = document.getElementById('top-products-list');
        
        // NUEVAS Referencias para el selector de estadísticas
        const statsPeriodSelector = document.getElementById('stats-period-selector');
        const refreshStatsBtn = document.getElementById('refresh-stats-btn');
        
        const paymentOptionsForm = document.getElementById('payment-options-form'); 
        const transactionDescriptionInput = document.getElementById('transaction-description'); 
        
        const cancelPaymentSelectionBtn = document.getElementById('cancel-payment-selection-btn'); 
        const confirmPaymentBtn = document.getElementById('confirm-payment-btn');
        const cancelLoginBtn = document.getElementById('cancel-login-btn');
        const cancelPaymentBtn = document.getElementById('cancel-payment-btn');
        const newTransactionBtn = document.getElementById('new-transaction-btn');
        
        const optionHugBank = document.getElementById('option-hug-bank');
        const optionCash = document.getElementById('option-cash');

        // --- FUNCIONES DE VISTA ---
        
        // Controla las vistas completas (Solo Login de Negocio)
        function switchAppView(target) {
            document.getElementById('business-login').classList.add('hidden');
            document.getElementById('charge-setup').classList.add('hidden');
            document.getElementById(target).classList.remove('hidden');
        }

        // Controla las sub-vistas del panel izquierdo (#dynamic-pos-panel)
        function switchDynamicView(target) {
            const views = [productCatalogView, paymentMethodView, customerLoginView, paymentConfirmationView, transactionCompleteView, statisticsView];
            views.forEach(view => view.classList.add('hidden'));

            switch (target) {
                case 'product-catalog-view':
                    productCatalogView.classList.remove('hidden');
                    break;
                case 'payment-method-view':
                    paymentMethodView.classList.remove('hidden');
                    break;
                case 'customer-login-view':
                    customerLoginView.classList.remove('hidden');
                    break;
                case 'payment-confirmation-view':
                    paymentConfirmationView.classList.remove('hidden');
                    break;
                case 'transaction-complete-view':
                    transactionCompleteView.classList.remove('hidden');
                    break;
                 case 'statistics-view': // Nuevo caso
                     statisticsView.classList.remove('hidden');
                     break;
            }
            switchAppView('charge-setup'); // Asegura que el POS principal esté visible
        }

        // --- RESTO DE UTILIDADES ---
        
        function showMessage(message, type = 'success') {
             messageBox.textContent = message;
             messageBox.className = 'mt-4 p-4 rounded-lg text-sm transition-all duration-300';
             if (type === 'success') {
                 messageBox.classList.add('bg-green-100', 'text-green-800');
             } else if (type === 'error') {
                 messageBox.classList.add('bg-red-100', 'text-red-800');
             } else if (type === 'info') {
                  messageBox.classList.add('bg-blue-100', 'text-blue-800');
             }
             messageBox.classList.remove('hidden');
 
             setTimeout(() => {
                 messageBox.classList.add('hidden');
             }, 5000);
        }

        async function saveProductCatalogToFirestore(products) {
            if (!businessUser) return;
            try {
                // Ruta: /artifacts/{appId}/users/{userId}/config/products
                const productConfigRef = doc(db, `artifacts/${appId}/users/${businessUser.uid}/config/products`);
                await setDoc(productConfigRef, { catalog: products, updated: serverTimestamp() });
            } catch (error) {
                console.error("Error al guardar el catálogo:", error);
                showMessage('Error al guardar el catálogo. No persistirá.', 'error');
            }
        }

        async function loadProductCatalogFromFirestore() {
            if (!businessUser) return [];
            try {
                // Ruta: /artifacts/{appId}/users/${userId}/config/products
                const productConfigRef = doc(db, `artifacts/${appId}/users/${businessUser.uid}/config/products`);
                const docSnap = await getDoc(productConfigRef);
                if (docSnap.exists() && docSnap.data().catalog) {
                    return docSnap.data().catalog;
                }
                return [];
            } catch (error) {
                console.error("Error al cargar el catálogo:", error);
                return [];
            }
        }
        
        function resetChargeState() {
             cart = []; 
             totalAmount = 0;
             paymentMethod = null;
             transactionDescription = ''; 
             document.getElementById('customer-login-form').reset();
             document.getElementById('transaction-description').value = ''; 
             
             // Resetear opciones de pago
             optionHugBank.checked = false;
             optionCash.checked = false;
             
             updateCartDisplay(); 
             switchDynamicView('product-catalog-view');
        }

        function resetAllState() {
             signOut(auth).catch(() => {});
             businessUser = null;
             cart = [];
             totalAmount = 0;
             paymentMethod = null;
             productCatalog = []; 
             transactionDescription = ''; 
             
             switchAppView('business-login');
        }
        
        function deleteProduct(index) {
             const productName = productCatalog[index].name;
             if (confirm(`¿Estás seguro de que quieres eliminar "${productName}" del catálogo?`)) {
                 productCatalog.splice(index, 1);
                 saveProductCatalogToFirestore(productCatalog);
                 updateProductListDisplay();
                 showMessage(`"${productName}" ha sido eliminado del catálogo.`, 'info');
             }
         }
         
        // --- FUNCIONES DE EDICIÓN (NUEVAS) ---

        /**
         * Abre el modal de edición y carga los datos del producto.
         * @param {number} index El índice del producto en el array productCatalog.
         */
        function openEditProductModal(index) {
            const product = productCatalog[index];
            if (!product) {
                showMessage('Error: Producto no encontrado.', 'error');
                return;
            }

            // 1. Cargar datos en el formulario
            editProductIndexInput.value = index;
            editProductNameInput.value = product.name;
            editProductEmojiInput.value = product.emoji;
            editProductPriceInput.value = product.price.toFixed(2);
            editProductCostInput.value = (product.cost || 0).toFixed(2);
            
            // 2. Mostrar el modal
            editProductModal.classList.remove('hidden');
        }

        /**
         * Oculta el modal de edición y limpia el formulario.
         */
        function closeEditProductModal() {
            editProductModal.classList.add('hidden');
            editProductForm.reset();
        }

        /**
         * Maneja el envío del formulario de edición.
         * @param {Event} e Evento de submit.
         */
        function handleEditProductSubmit(e) {
            e.preventDefault();
            const index = parseInt(editProductIndexInput.value);
            const name = editProductNameInput.value.trim();
            const emoji = editProductEmojiInput.value.trim().slice(0, 2); 
            let price;
            let cost;

            try {
                 price = parseFloat(editProductPriceInput.value);
                 if (isNaN(price) || price <= 0) {
                      throw new Error("Precio inválido");
                 }
             cost = parseFloat(editProductCostInput.value);
             if (isNaN(cost) || cost < 0) {
                 throw new Error("Costo inválido");
             }
            } catch (error) {
                 showMessage('Por favor, ingrese un precio positivo y válido.', 'error');
                 return;
            }
            
            if (name.length === 0) {
                 showMessage('El nombre del producto no puede estar vacío.', 'error');
                 return;
            }

            // 1. Actualizar el catálogo local
            const updatedProduct = { 
                name: name, 
                price: parseFloat(price.toFixed(2)), 
                emoji: emoji || '📦', 
                cost: parseFloat(cost.toFixed(2))
            };
            
            productCatalog[index] = updatedProduct;

            // 2. Guardar los cambios en Firestore
            saveProductCatalogToFirestore(productCatalog);
            
            // 3. Actualizar la UI del catálogo
            updateProductListDisplay();
            
            // 4. Cerrar el modal y mostrar mensaje
            closeEditProductModal();
            showMessage(`"${name}" ha sido actualizado.`, 'success');
        }
        
        // --- FIN FUNCIONES DE EDICIÓN ---
        
        function updateProductListDisplay() {
            productList.innerHTML = '';
            
            if (productCatalog.length === 0) {
                 productList.innerHTML = '<p class="col-span-3 text-center text-gray-500" id="empty-catalog-message">Catálogo vacío. Use el botón (+) para añadir su primer producto.</p>';
            } else {
                productCatalog.forEach((product, index) => {
                    const card = document.createElement('div');
                    // Añadimos 'relative group' para el botón de borrar/editar
                    card.className = 'product-card bg-gray-100 p-3 text-center rounded-lg relative group'; 
                    card.dataset.index = index;
                    card.innerHTML = `
                         <button data-index="${index}" class="delete-product-btn absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs leading-none opacity-0 group-hover:opacity-100 transition-opacity z-10" title="Eliminar Producto">&times;</button>
                         <button data-index="${index}" class="edit-product-btn absolute top-1 left-1 bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs leading-none opacity-0 group-hover:opacity-100 transition-opacity z-10" title="Editar Producto">✎</button>
                         <span class="block text-2xl">${product.emoji}</span>
                        <p class="text-sm font-medium truncate">${product.name}</p>
                        <p class="text-xs font-bold text-gray-700">Precio: $${product.price.toFixed(2)} <span class="text-xs text-gray-500">| Costo: $${(product.cost||0).toFixed(2)}</span></p>
                    `;
                    
                    // Evento para añadir al carrito (IGNORA si se hace clic en el botón de borrar/editar)
                    card.addEventListener('click', (e) => {
                         if (e.target.classList.contains('delete-product-btn') || e.target.classList.contains('edit-product-btn')) return; 
                         const idx = parseInt(e.currentTarget.dataset.index);
                         addProductToCart(productCatalog[idx]);
                    });
                    
                    // Evento para borrar el producto
                    card.querySelector('.delete-product-btn').addEventListener('click', (e) => {
                         const idx = parseInt(e.currentTarget.dataset.index);
                         deleteProduct(idx);
                    });
                    
                    // EVENTO PARA EDITAR PRODUCTO (NUEVO)
                    card.querySelector('.edit-product-btn').addEventListener('click', (e) => {
                         const idx = parseInt(e.currentTarget.dataset.index);
                         openEditProductModal(idx);
                    });
                    
                    productList.appendChild(card);
                });
            }
        }
        
        function addProductToCart(product) {
            cart.push({ name: product.name, price: product.price, emoji: product.emoji, cost: product.cost || 0 });
            updateCartDisplay();
            showMessage(`${product.name} ($${product.price.toFixed(2)}) agregado al carrito.`, 'info');
        }

        function updateCartDisplay() {
            cartItemsContainer.innerHTML = '';
            totalAmount = cart.reduce((sum, item) => sum + item.price, 0);
            displayTotalAmount.textContent = `$${totalAmount.toFixed(2)}`;
            checkoutBtn.disabled = totalAmount <= 0;
            
            if (cart.length === 0) {
                 cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center" id="empty-cart-message">Seleccione productos en la izquierda.</p>';
            } else {
                cart.forEach((item, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between text-sm items-center py-1 border-b last:border-b-0';
                    itemEl.innerHTML = `
                        <span>${item.emoji || '📦'} ${item.name}</span>
                        <div class="flex items-center">
                            <span class="font-medium mr-2">$${item.price.toFixed(2)}</span>
                            <span class="text-xs text-gray-500 mr-3">(Costo $${(item.cost||0).toFixed(2)})</span>
                            <button data-index="${index}" class="remove-item-btn text-red-500 hover:text-red-700 text-lg leading-none" title="Quitar">&times;</button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemEl);
                });
            }
            document.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    removeItemFromCart(index);
                });
            });
        }
        
        function removeItemFromCart(index) {
             cart.splice(index, 1);
             updateCartDisplay();
        }

        async function loadBalance(userId) {
             try {
                const userAccountRef = doc(db, `artifacts/${appId}/users/${userId}/account/data`);
                const docSnap = await getDoc(userAccountRef);
                if (docSnap.exists()) {
                    return docSnap.data().balance;
                }
                return 0;
            } catch (error) {
                console.error("Error al cargar el saldo:", error);
                return 0;
            }
        }
        
        async function getAccountData(userId) {
             const userAccountRef = doc(db, `artifacts/${appId}/users/${userId}/account/data`);
             const docSnap = await getDoc(userAccountRef);
             if (docSnap.exists()) return docSnap.data();
             return null;
        }

        async function createTransaction(userId, transactionData) {
            const transactionsRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
            return await addDoc(transactionsRef, { ...transactionData, timestamp: serverTimestamp() });
        }
        
        function showCompletionScreen(success, title, message) {
            const icon = document.getElementById('complete-icon');
            const titleEl = document.getElementById('complete-title');
            const messageEl = document.getElementById('complete-message');

            if (success) {
                icon.textContent = '✅';
                titleEl.classList.remove('text-red-500');
                titleEl.classList.add('text-green-600');
            } else {
                icon.textContent = '❌';
                titleEl.classList.remove('text-green-600');
                titleEl.classList.add('text-red-500');
            }
            titleEl.textContent = title;
            messageEl.textContent = message;
            // Cerrar sesión del cliente tras la transacción
            if (typeof clientAuth !== 'undefined' && clientAuth.currentUser) {
                clientAuth.signOut().catch(() => {});
                clientUser = null;
            }
            switchDynamicView('transaction-complete-view');
        }

        
        // --- FUNCIÓN DE RANGO DE TIEMPO (NUEVA) ---
        
        /**
         * Calcula el rango de tiempo (start y end Date objects) para el periodo seleccionado.
         * @param {string} period 'daily', 'monthly', 'yearly', 'total'
         * @returns {{start: Date|null, end: Date|null}}
         */
        function getPeriodRange(period) {
            const now = new Date();
            let start = null;
            let end = null; 

            switch (period) {
                case 'daily':
                    // Inicio del día actual (00:00:00)
                    start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
                    // Final del día actual (23:59:59.999)
                    end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                    break;
                case 'monthly':
                    // Inicio del mes actual (día 1, 00:00:00)
                    start = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
                    // Final del mes actual (último día, 23:59:59.999)
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    break;
                case 'yearly':
                    // Inicio del año actual (1 de enero, 00:00:00)
                    start = new Date(now.getFullYear(), 0, 1, 0, 0, 0, 0);
                    // Final del año actual (31 de diciembre, 23:59:59.999)
                    end = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
                    break;
                case 'total':
                default:
                    return { start: null, end: null }; // Sin filtro de fecha
            }
            return { start, end };
        }
        
        // --- FUNCIÓN DE ESTADÍSTICAS MODIFICADA ---

        async function loadSalesStatistics(period = 'total') {
            topProductsList.innerHTML = '<p class="text-center text-gray-500">Cargando datos de ventas...</p>';
            totalRevenueDisplay.textContent = '$0.00';
            totalItemsDisplay.textContent = '0';
            
            if (!businessUser) return;

            const transactionsRef = collection(db, `artifacts/${appId}/users/${businessUser.uid}/transactions`);
            
            try {
                const { start, end } = getPeriodRange(period);
                let q = query(transactionsRef);

                if (start && end) {
                     // Aplicar el filtro de rango de fecha a la consulta
                     // ¡IMPORTANTE! Requiere un índice compuesto en Firestore: timestamp (asc), type (asc)
                     q = query(transactionsRef, 
                         where('timestamp', '>=', start),
                         where('timestamp', '<=', end)
                     );
                }
                
                const querySnapshot = await getDocs(q);
                
                let totalRevenue = 0;
                let totalItemsSold = 0;
                let totalCost = 0;
                const productSales = {}; // { productName: { count: N, revenue: M, emoji: E } }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Solo considerar transacciones de cobro (pos-payment-received-cash o pos-payment-received)
                    if (data.type && (data.type.startsWith('pos-payment-received'))) {
                        const transactionAmount = data.amount || 0;
                        totalRevenue += transactionAmount;
                        
                        if (data.items && Array.isArray(data.items)) {
                            data.items.forEach(item => {
                                const key = item.name;
                                totalItemsSold += 1;
                                totalCost += item.cost || 0;
                                
                                if (!productSales[key]) {
                                    productSales[key] = { count: 0, revenue: 0, cost: 0, emoji: item.emoji || '📦' };
                                }
                                
                                productSales[key].count += 1;
                                productSales[key].revenue += item.price || 0;
                                productSales[key].cost += item.cost || 0;
                            });
                        }
                    }
                });
                
                // Convertir el objeto a un array y ordenar por conteo
                const sortedProducts = Object.keys(productSales).map(key => ({
                    name: key,
                    ...productSales[key]
                })).sort((a, b) => b.count - a.count);

                // Actualizar la UI
                totalRevenueDisplay.textContent = `$${totalRevenue.toFixed(2)}`;
                totalItemsDisplay.textContent = totalItemsSold.toString();
                const totalProfit = totalRevenue - totalCost;
                // actualizar displays nuevos
                const totalCostDisplay = document.getElementById('total-cost-display');
                const totalProfitDisplay = document.getElementById('total-profit-display');
                if (totalCostDisplay) totalCostDisplay.textContent = `$${totalCost.toFixed(2)}`;
                if (totalProfitDisplay) totalProfitDisplay.textContent = `$${totalProfit.toFixed(2)}`;
                
                topProductsList.innerHTML = '';

                if (sortedProducts.length === 0) {
                    topProductsList.innerHTML = '<p class="text-center text-gray-500">No hay transacciones de venta registradas para este periodo.</p>';
                } else {
                    sortedProducts.forEach(product => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'flex justify-between items-center p-3 bg-white border rounded-lg shadow-sm';
                        itemEl.innerHTML = `
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">${product.emoji}</span>
                                <span class="font-medium text-gray-800">${product.name}</span>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold text-green-700">Ingreso: $${product.revenue.toFixed(2)}</p>
                                <p class="text-xs text-gray-500">Costo: $${(product.cost||0).toFixed(2)} · ${product.count} vendidos</p>
                            </div>
                        `;
                        topProductsList.appendChild(itemEl);
                    });
                }

            } catch (error) {
                console.error("Error al cargar estadísticas de ventas:", error);
                topProductsList.innerHTML = '<p class="text-center text-red-500">Error al cargar las estadísticas. Asegúrese de tener el índice de Firestore correcto.</p>';
                showMessage('Error al cargar las estadísticas de ventas.', 'error');
            }
        }
        
        // --- FUNCIÓN NUEVA: Generar Descripción de Transacción ---
        function generateTransactionDescription() {
            if (cart.length === 0) return "";

            // 1. Agrupar los ítems para contar las cantidades
            const itemCounts = cart.reduce((acc, item) => {
                const key = item.name; // Usamos el nombre como clave para agrupar
                if (!acc[key]) {
                    acc[key] = { count: 0, name: item.name };
                }
                acc[key].count++;
                return acc;
            }, {});

            // 2. Formatear la cadena: "Nombre xCantidad"
            const descriptionArray = Object.values(itemCounts).map(item => {
                return `${item.name} x${item.count}`;
            });

            // 3. Unir con comas y devolver
            return descriptionArray.join(', ');
        }
        // --- FIN FUNCIÓN NUEVA ---


        // --- MANEJO DE EVENTOS ---

        // V0: Login del Negocio
        businessLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('business-email').value;
            const password = document.getElementById('business-password').value;
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                businessUser = { uid: user.uid, name: user.displayName || 'Negocio' };
                // Guardar sesión en localStorage
                localStorage.setItem('hugbank-business-user', JSON.stringify({ uid: user.uid, name: businessUser.name, email: user.email }));
                productCatalog = await loadProductCatalogFromFirestore();
                document.getElementById('business-name-display').textContent = businessUser.name;
                updateCartDisplay();
                updateProductListDisplay();
                switchDynamicView('product-catalog-view');
            } catch (error) {
                console.error("Error de inicio de sesión del negocio:", error);
                showMessage('Error de inicio de sesión: Credenciales del negocio incorrectas.', 'error');
            }
        });
        
        businessLogoutBtn.addEventListener('click', () => {
            // Limpiar localStorage y cerrar sesión
            localStorage.removeItem('hugbank-business-user');
            resetAllState();
        });

        // Eventos para la nueva vista de Estadísticas
        const updateStatsHandler = () => {
             const selectedPeriod = statsPeriodSelector.value;
             loadSalesStatistics(selectedPeriod);
        };
        
        toggleStatisticsBtn.addEventListener('click', () => {
             updateStatsHandler(); // Carga inicial al entrar
             switchDynamicView('statistics-view');
        });
        
        backToPosBtn.addEventListener('click', () => {
             switchDynamicView('product-catalog-view');
        });
        
        // NUEVOS Event Listeners para el selector y el botón
        statsPeriodSelector.addEventListener('change', updateStatsHandler);
        refreshStatsBtn.addEventListener('click', updateStatsHandler);


        // V1: Configuración del Cobro (Product Management)
        toggleAddProductFormBtn.addEventListener('click', () => {
            addProductForm.classList.toggle('hidden');
            toggleAddProductFormBtn.textContent = addProductForm.classList.contains('hidden') ? '+' : '−';
        });
        
        addProductForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('product-name').value.trim();
            const emoji = document.getElementById('product-emoji').value.trim().slice(0, 2); 
            let price;

            try {
                 price = parseFloat(document.getElementById('product-price').value);
                 if (isNaN(price) || price <= 0) {
                      throw new Error("Precio inválido");
                 }
            } catch (error) {
                 showMessage('Por favor, ingrese un precio positivo y válido.', 'error');
                 return;
            }
            
            if (name.length === 0) {
                 showMessage('El nombre del producto no puede estar vacío.', 'error');
                 return;
            }
            
            const newProduct = { 
                name: name, 
                price: parseFloat(price.toFixed(2)), 
                emoji: emoji || '📦' 
            };

            productCatalog.push(newProduct);
            saveProductCatalogToFirestore(productCatalog);
            updateProductListDisplay();
            
            addProductForm.reset();
            addProductForm.classList.add('hidden');
            toggleAddProductFormBtn.textContent = '+';
        });
        
        clearCartBtn.addEventListener('click', () => {
             cart = [];
             updateCartDisplay();
             showMessage('Carrito de compras vaciado.', 'info');
        });

        // --- MANEJO DE EVENTOS DE EDICIÓN (NUEVOS) ---
        editProductForm.addEventListener('submit', handleEditProductSubmit);
        cancelEditBtn.addEventListener('click', closeEditProductModal);
        // --- FIN MANEJO DE EVENTOS DE EDICIÓN ---

        // Evento: Proceder al Pago (Checkout)
        checkoutBtn.addEventListener('click', () => {
            if (totalAmount <= 0) {
                showMessage('Debe seleccionar productos para proceder al pago.', 'error');
                return;
            }
            
            document.getElementById('display-charge-amount-payment-method').textContent = `$${totalAmount.toFixed(2)}`;
            
            // Pre-llenar la descripción de la transacción con los productos del carrito
            transactionDescriptionInput.value = generateTransactionDescription(); 
            
            // Asegurarse de que ninguna opción esté seleccionada al entrar a la vista
            optionHugBank.checked = false;
            optionCash.checked = false;

            switchDynamicView('payment-method-view');
        });

        
        // V2: Selección de Método de Pago (Simplificada)
        paymentOptionsForm.addEventListener('change', async (e) => {
            const selectedOption = e.target.value;
            
            // Obtener la descripción del campo de texto
            transactionDescription = transactionDescriptionInput.value.trim(); 
            
            if (selectedOption === 'cash') {
                 // Opción Efectivo - Ejecución directa
                 paymentMethod = 'cash';
                 
                 if (!businessUser) {
                     showCompletionScreen(false, 'Error', 'Sesión del negocio perdida. Por favor, reinicie.');
                     return;
                 }
                 
                 try {
                     const businessId = businessUser.uid;
                     
                     // 1. Crear el objeto de la transacción para efectivo
                     const transactionDetails = {
                         amount: totalAmount, 
                         hugBankAmount: 0, 
                         cashAmount: totalAmount, 
                         description: transactionDescription || 'Pago en efectivo', // Usamos la descripción generada
                         senderId: 'CASH', 
                         recipientId: businessId,
                         type: 'pos-payment-received-cash', // Nuevo tipo para efectivo
                         senderName: 'Pago en efectivo',
                         recipientName: businessUser.name,
                         items: cart, // ESENCIAL para las estadísticas
                     };

                     // 2. Registrar la transacción solo para el negocio
                     await createTransaction(businessId, transactionDetails);

                     const msgDesc = transactionDescription ? ` (${transactionDescription})` : ''; 
                     showCompletionScreen(true, 'Cobro en Efectivo Exitoso', `Se recibió $${totalAmount.toFixed(2)} en efectivo${msgDesc}. Transacción registrada.`);
                     
                 } catch (error) {
                      console.error("Error al registrar transacción en efectivo:", error);
                      showCompletionScreen(false, 'Error', `Cobro en efectivo realizado, pero falló el registro de la transacción: ${error.message}`);
                 }


            } else if (selectedOption === 'hug-bank') {
                 // Opción HUG Bank - Va a Login de Cliente
                 paymentMethod = 'hug-bank';
                 
                 document.getElementById('display-charge-amount-login').textContent = `$${totalAmount.toFixed(2)}`;
                 document.getElementById('display-charge-amount-confirm').textContent = `$${totalAmount.toFixed(2)}`;
                 switchDynamicView('customer-login-view');
            }
        });

        cancelPaymentSelectionBtn.addEventListener('click', () => {
            resetChargeState();
            showMessage('Transacción cancelada por el negocio.', 'info');
        });


        // V3 y V4: Login de Cliente y Confirmación 
        document.getElementById('customer-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('customer-email').value;
            const password = document.getElementById('customer-password').value;
            try {
                const userCredential = await signInWithEmailAndPassword(clientAuth, email, password);
                const user = userCredential.user;
                clientUser = user;
                document.getElementById('customer-name-display').textContent = user.displayName || 'Cliente';
                const balance = await loadBalance(user.uid);
                document.getElementById('display-current-balance').textContent = `$${balance.toFixed(2)}`;
                switchDynamicView('payment-confirmation-view');
            } catch (error) {
                console.error("Error de inicio de sesión del cliente:", error);
                showMessage('Error de inicio de sesión del cliente: Credenciales incorrectas.', 'error');
            }
        });

        cancelLoginBtn.addEventListener('click', () => {
            if (clientAuth.currentUser) signOut(clientAuth).catch(() => {});
            clientUser = null;
            showMessage('Login cancelado. Vuelva a intentar o seleccione otro método.', 'info');
            switchDynamicView('payment-method-view');
        });

        confirmPaymentBtn.addEventListener('click', async () => {
            const customerUser = clientAuth.currentUser;
            // El monto a cobrar es siempre el total
            const chargeAmount = totalAmount;
            if (!customerUser || chargeAmount <= 0) {
                showCompletionScreen(false, 'Error', 'No hay un cliente autenticado o un monto válido para HUG Bank.');
                return;
            }
            if (!businessUser) {
                showCompletionScreen(false, 'Error', 'Sesión del negocio perdida. Por favor, reinicie.');
                return;
            }
            const customerId = customerUser.uid;
            const businessId = businessUser.uid;
            const customerRef = doc(db, `artifacts/${appId}/users/${customerId}/account/data`);
            const businessRef = doc(db, `artifacts/${appId}/users/${businessId}/account/data`);
            try {
                await runTransaction(db, async (transaction) => {
                    const customerDoc = await transaction.get(customerRef);
                    if (!customerDoc.exists()) throw new Error("Cuenta del cliente no existe.");
                    const businessDoc = await transaction.get(businessRef);
                    const customerBalance = customerDoc.data().balance;
                    if (customerBalance < chargeAmount) {
                        throw new Error("Saldo insuficiente en la cuenta del cliente.");
                    }
                    const newCustomerBalance = customerBalance - chargeAmount;
                    let currentBusinessBalance = businessDoc.exists() ? businessDoc.data().balance : 0;
                    const newBusinessBalance = currentBusinessBalance + chargeAmount;
                    transaction.update(customerRef, { balance: newCustomerBalance });
                    if (!businessDoc.exists()) {
                        transaction.set(businessRef, {
                            balance: newBusinessBalance,
                            name: businessUser.name,
                            email: customerUser.email,
                            creditScore: { average: 5.0, count: 0 }
                        });
                    } else {
                        transaction.update(businessRef, { balance: newBusinessBalance });
                    }
                });
                // NOTA: Usar la 'transactionDescription' que se guardó al seleccionar el método de pago
                const transactionDetails = {
                    amount: totalAmount,
                    hugBankAmount: totalAmount, // Solo HUG Bank
                    cashAmount: 0, // No hay efectivo
                    description: transactionDescription,
                    senderId: customerId,
                    recipientId: businessId,
                    type: 'pos-payment-sent', // Tipo simple para el cliente
                    senderName: customerUser.displayName || 'Cliente',
                    recipientName: businessUser.name,
                    items: cart // ESENCIAL para las estadísticas
                };
                // Transacción para el Cliente (Salida de dinero)
                await createTransaction(customerId, transactionDetails);
                // Transacción para el Negocio (Entrada de dinero)
                transactionDetails.type = 'pos-payment-received';
                transactionDetails.senderName = customerUser.displayName || 'Cliente'; // Asegurar el nombre en el lado del negocio
                await createTransaction(businessId, transactionDetails);
                const finalMessage = `Se cobró $${chargeAmount.toFixed(2)} al cliente y se acreditó al negocio. ${transactionDescription ? '(' + transactionDescription + ')' : ''}`;
                showCompletionScreen(true, '¡Pago Exitoso!', finalMessage);
            } catch (e) {
                console.error("Fallo de Transacción:", e.message);
                let msg = e.message.includes("Saldo insuficiente")
                    ? "Saldo insuficiente para cubrir el cobro de HUG Bank."
                    : `Fallo la transacción: ${e.message}`;
                showCompletionScreen(false, 'Pago Fallido', msg);
            }
        });
        
        cancelPaymentBtn.addEventListener('click', () => {
            // Cerrar sesión del cliente si cancela
            if (typeof clientAuth !== 'undefined' && clientAuth.currentUser) {
                clientAuth.signOut().catch(() => {});
                clientUser = null;
            }
            showCompletionScreen(false, 'Transacción Cancelada', 'El cliente decidió cancelar el pago.');
        });
        
        newTransactionBtn.addEventListener('click', () => {
             resetChargeState(); 
        });



        // --- CONTROL DE SESIÓN DE NEGOCIO Y CLIENTE ---
        async function restoreBusinessSession() {
            // Si hay usuario guardado en localStorage, restaurar datos mínimos y saltar login
            const saved = localStorage.getItem('hugbank-business-user');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    // Comprobar si sigue autenticado
                    if (!auth.currentUser || auth.currentUser.uid !== data.uid) {
                        // Forzar re-autenticación silenciosa si es posible (no hay refresh token, así que solo restaurar datos UI)
                        businessUser = { uid: data.uid, name: data.name, email: data.email };
                        document.getElementById('business-name-display').textContent = businessUser.name;
                        productCatalog = await loadProductCatalogFromFirestore();
                        updateCartDisplay();
                        updateProductListDisplay();
                        switchDynamicView('product-catalog-view');
                        return true;
                    } else {
                        businessUser = { uid: auth.currentUser.uid, name: auth.currentUser.displayName || data.name, email: auth.currentUser.email };
                        document.getElementById('business-name-display').textContent = businessUser.name;
                        productCatalog = await loadProductCatalogFromFirestore();
                        updateCartDisplay();
                        updateProductListDisplay();
                        switchDynamicView('product-catalog-view');
                        return true;
                    }
                } catch (e) {
                    localStorage.removeItem('hugbank-business-user');
                }
            }
            return false;
        }

        // No usar onAuthStateChanged para cambiar de vista, solo para actualizar datos si cambia el usuario de negocio
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                businessUser = { uid: user.uid, name: user.displayName || 'Negocio', email: user.email };
                localStorage.setItem('hugbank-business-user', JSON.stringify(businessUser));
                document.getElementById('business-name-display').textContent = businessUser.name;
                productCatalog = await loadProductCatalogFromFirestore();
                updateProductListDisplay();
            }
        });

        // Cliente: solo actualizar datos de UI, nunca cerrar sesión de negocio
        onAuthStateChanged(clientAuth, async (user) => {
            if (user) {
                clientUser = user;
                document.getElementById('customer-name-display').textContent = user.displayName || 'Cliente';
                const balance = await loadBalance(user.uid);
                document.getElementById('display-current-balance').textContent = `$${balance.toFixed(2)}`;
                document.getElementById('display-charge-amount-confirm').textContent = `$${totalAmount.toFixed(2)}`;
                switchDynamicView('payment-confirmation-view');
            } else {
                clientUser = null;
            }
        });

        // Al cargar la página, restaurar sesión de negocio si existe
        (async () => {
            const restored = await restoreBusinessSession();
            if (!restored) {
                switchAppView('business-login');
            }
        })();

    </script>
</body>
</html>
