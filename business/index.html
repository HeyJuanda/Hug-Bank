<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="bank.png" />
    <title>HUG Bank - Sistema de Pago para Negocios (POS)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --hug-primary: #007bff;
            --hug-secondary: #f3f4f6;
            --hug-text-color: #1f2937;
            --hug-header: #3b82f6;
            --hug-danger: #dc3545;
        }
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacs, sans-serif;
            background-color: var(--hug-secondary);
            color: var(--hug-text-color);
        }
        .bg-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: var(--hug-primary);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-danger {
            background-color: var(--hug-danger);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .header-bar {
            background-color: var(--hug-header);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem 0.75rem 0 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 md:p-8">

    <div id="app" class="w-full max-w-lg">
        
        <div id="business-login" class="bg-card p-6 md:p-8">
            <h2 class="text-3xl font-bold mb-6 text-center text-hug-header">
                 <img src="bank.svg" alt="POS Logo" class="inline h-10 w-10 mr-2 align-middle">
                 Acceso de Negocio (POS)
            </h2>
            <form id="business-login-form" class="space-y-4">
                 <p class="text-center text-lg font-medium">Inicia sesión con tu cuenta HUG Bank</p>
                <div>
                    <label for="business-email" class="block text-sm font-medium">Correo Electrónico del Negocio</label>
                    <input type="email" id="business-email" required placeholder="negocio@ejemplo.com"
                           class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="business-password" class="block text-sm font-medium">Contraseña</label>
                    <input type="password" id="business-password" required placeholder="********"
                           class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full py-3 px-4 rounded-full text-lg font-semibold text-white btn-primary">
                    Ingresar al POS
                </button>
            </form>
        </div>
        
        <div id="charge-setup" class="hidden bg-card p-6 md:p-8">
            <div class="flex justify-between items-center mb-6">
                 <h2 class="text-2xl font-bold text-hug-header">Cobro en Caja</h2>
                 <button id="business-logout-btn" class="py-1 px-3 rounded-full text-sm font-semibold text-white bg-gray-500 hover:bg-gray-700">
                    Cerrar Sesión
                 </button>
            </div>
            
            <p class="mb-4 text-sm">Bienvenido, <span id="business-name-display" class="font-bold"></span></p>

            <form id="merchant-form" class="space-y-6">
                <p class="text-center text-lg font-medium">Paso 1: Ingresar Monto a Cobrar</p>
                <div>
                    <label for="charge-amount" class="block text-sm font-medium">Monto Total ($)</label>
                    <input type="number" id="charge-amount" required **min="0.01"** step="0.01" placeholder="Ej: 45.99"
                           class="mt-1 block w-full px-3 py-3 border rounded-lg text-2xl font-bold focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full py-3 px-4 rounded-full text-lg font-semibold text-white btn-primary">
                    Cobrar al Cliente
                </button>
            </form>
        </div>

        <div id="customer-login" class="hidden bg-card p-6 md:p-8">
            <h2 class="text-2xl font-bold mb-2 text-center">
                Monto a Pagar: <span id="display-charge-amount-login" class="text-hug-danger">$0.00</span>
            </h2>
            <p class="text-center text-lg font-medium mb-6">Paso 2: Cliente debe Iniciar Sesión</p>

            <form id="customer-login-form" class="space-y-4">
                <div>
                    <label for="customer-email" class="block text-sm font-medium">Correo Electrónico del Cliente</label>
                    <input type="email" id="customer-email" required placeholder="tu.correo@ejemplo.com"
                           class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="customer-password" class="block text-sm font-medium">Contraseña del Cliente</label>
                    <input type="password" id="customer-password" required placeholder="********"
                           class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full py-3 px-4 rounded-full text-lg font-semibold text-white btn-primary">
                    Continuar al Pago
                </button>
            </form>
            <button id="cancel-login-btn" class="w-full mt-4 py-3 px-4 rounded-full text-lg font-semibold btn-danger">
                Cancelar Transacción
            </button>
        </div>

        <div id="payment-confirmation" class="hidden bg-card p-6 md:p-8 text-center">
             <h2 class="text-3xl font-extrabold mb-4 text-hug-header">Confirmación de Pago</h2>

             <div class="bg-blue-50 p-6 rounded-xl border border-blue-200 mb-6">
                <p class="text-sm text-blue-600">Total a Cobrar</p>
                <h3 class="text-5xl font-extrabold mt-1 text-hug-danger" id="display-charge-amount-confirm">$0.00</h3>
                <p class="text-sm text-blue-600 mt-2">Tu Saldo Actual: <span id="display-current-balance" class="font-bold">$0.00</span></p>
             </div>
             
             <p class="mb-6 text-lg">Paso 3: Aprobar el Pago por <span id="customer-name-display" class="font-bold">Cliente</span></p>

            <button id="confirm-payment-btn" class="w-full py-3 px-4 rounded-full text-lg font-semibold text-white btn-primary">
                Aprobar Pago
            </button>
            <button id="cancel-payment-btn" class="w-full mt-4 py-3 px-4 rounded-full text-lg font-semibold btn-danger">
                Cancelar Transacción
            </button>
        </div>
        
        <div id="transaction-complete" class="hidden bg-card p-6 md:p-8 text-center">
            <div id="complete-icon" class="text-6xl mb-4"></div>
            <h2 id="complete-title" class="text-3xl font-bold mb-2"></h2>
            <p id="complete-message" class="mb-8 text-gray-600"></p>
            
            <h3 class="text-xl font-bold mb-4">Listo para el Siguiente Cliente</h3>

            <button id="new-transaction-btn" class="w-full py-3 px-4 rounded-full text-lg font-semibold text-white btn-primary">
                Iniciar Nueva Transacción
            </button>
        </div>

        <div id="message-box" class="mt-4 p-4 rounded-lg text-sm hidden" role="alert"></div>

    </div>
    
    <script type="module">
        // IMPORTACIONES DE FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, runTransaction, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE ---
        const demoFirebaseConfig = {
            apiKey: "AIzaSyBedGoV0Lp_i0Z2wo1_0SkaJa_NrZTPN2g",
            authDomain: "hug-bank.firebaseapp.com",
            projectId: "hug-bank",
            storageBucket: "hug-bank.firebasestorage.app",
            messagingSenderId: "891285624181",
            appId: "1:891285624181:web:c37e3a50275353af88af3c",
            measurementId: "G-5HDSRH2SB2"
        };
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : demoFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables de sesión
        let businessUser = null; // Guarda el UID y nombre del negocio (sesión persistente en JS, no en Firebase Auth)
        let chargeAmount = 0; 
        
        // --- REFERENCIAS DE UI ---
        const messageBox = document.getElementById('message-box');
        const businessLoginForm = document.getElementById('business-login-form');
        const customerLoginForm = document.getElementById('customer-login-form');
        const merchantForm = document.getElementById('merchant-form');
        const confirmPaymentBtn = document.getElementById('confirm-payment-btn');
        const cancelLoginBtn = document.getElementById('cancel-login-btn');
        const cancelPaymentBtn = document.getElementById('cancel-payment-btn');
        const newTransactionBtn = document.getElementById('new-transaction-btn');
        const businessLogoutBtn = document.getElementById('business-logout-btn');
        
        // --- UTILIDADES Y VISTAS ---
        
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = 'mt-4 p-4 rounded-lg text-sm transition-all duration-300';
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'info') {
                 messageBox.classList.add('bg-blue-100', 'text-blue-800');
            }
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        function switchView(target) {
            document.getElementById('business-login').classList.add('hidden');
            document.getElementById('charge-setup').classList.add('hidden');
            document.getElementById('customer-login').classList.add('hidden');
            document.getElementById('payment-confirmation').classList.add('hidden');
            document.getElementById('transaction-complete').classList.add('hidden');
            document.getElementById(target).classList.remove('hidden');
        }
        
        function resetChargeState() {
             // Limpia el estado de cobro y vuelve a la vista de configuración
             chargeAmount = 0;
             document.getElementById('charge-amount').value = '';
             document.getElementById('customer-login-form').reset();
             
             // Mantiene la sesión del cliente abierta (si existe)
             switchView('charge-setup');
        }

        function resetAllState() {
             // Cierra la sesión de negocio O cliente
             signOut(auth).catch(() => {});
             businessUser = null;
             
             // Vuelve a la vista de login de negocio
             switchView('business-login');
        }

        // --- FIREBASE HELPER FUNCTIONS ---
        
        async function loadBalance(userId) {
             try {
                const userAccountRef = doc(db, `artifacts/${appId}/users/${userId}/account/data`);
                const docSnap = await getDoc(userAccountRef);
                if (docSnap.exists()) {
                    return docSnap.data().balance;
                }
                return 0;
            } catch (error) {
                console.error("Error al cargar el saldo:", error);
                return 0;
            }
        }
        
        async function getAccountData(userId) {
             const userAccountRef = doc(db, `artifacts/${appId}/users/${userId}/account/data`);
             const docSnap = await getDoc(userAccountRef);
             if (docSnap.exists()) return docSnap.data();
             return null;
        }

        async function createTransaction(userId, transactionData) {
            const transactionsRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
            return await addDoc(transactionsRef, { ...transactionData, timestamp: serverTimestamp() });
        }
        
        // Función para mostrar el resultado final.
        function showCompletionScreen(success, title, message) {
            const icon = document.getElementById('complete-icon');
            const titleEl = document.getElementById('complete-title');
            const messageEl = document.getElementById('complete-message');

            if (success) {
                icon.textContent = '✅';
                titleEl.classList.remove('text-red-500');
                titleEl.classList.add('text-green-600');
            } else {
                icon.textContent = '❌';
                titleEl.classList.remove('text-green-600');
                titleEl.classList.add('text-red-500');
            }
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // ** CORRECCIÓN: Llamada a signOut(auth) para cerrar la sesión del cliente al finalizar la transacción. **
            signOut(auth).catch(() => {});
            
            switchView('transaction-complete');
        }


        // --- MANEJO DE EVENTOS ---

        // V0: Login del Negocio
        businessLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('business-email').value;
            const password = document.getElementById('business-password').value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                businessUser = { uid: user.uid, name: user.displayName || 'Negocio' };
                
                document.getElementById('business-name-display').textContent = businessUser.name;
                
                // Cerramos la sesión del negocio inmediatamente para liberar el slot de auth.currentUser para el cliente
                signOut(auth);
                
                switchView('charge-setup'); 

            } catch (error) {
                console.error("Error de inicio de sesión del negocio:", error);
                showMessage('Error de inicio de sesión: Credenciales del negocio incorrectas.', 'error');
            }
        });
        
        // Logout del Negocio
        businessLogoutBtn.addEventListener('click', resetAllState);


        // V1: Configuración del Cobro (Business is active)
        merchantForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('charge-amount').value);
            
            if (amount <= 0 || isNaN(amount)) {
                showMessage('El monto de cobro debe ser positivo.', 'error');
                return;
            }

            chargeAmount = amount;
            document.getElementById('display-charge-amount-login').textContent = `$${chargeAmount.toFixed(2)}`;
            document.getElementById('display-charge-amount-confirm').textContent = `$${chargeAmount.toFixed(2)}`;
            
            // Pasa a la vista de login del cliente
            switchView('customer-login');
        });


        // V2: Inicio de Sesión del Cliente
        customerLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('customer-email').value;
            const password = document.getElementById('customer-password').value;
            
            // Si el cliente anterior está logueado, esta llamada lo cerrará antes de intentar el nuevo login
            signOut(auth);
            
            try {
                // Autenticación del cliente
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // El cliente es ahora el auth.currentUser
                document.getElementById('customer-name-display').textContent = user.displayName || 'Cliente';
                const balance = await loadBalance(user.uid);
                document.getElementById('display-current-balance').textContent = `$${balance.toFixed(2)}`;
                
                // Pasa a la vista de confirmación
                switchView('payment-confirmation');
                
            } catch (error) {
                console.error("Error de inicio de sesión del cliente:", error);
                showMessage('Error de inicio de sesión del cliente: Credenciales incorrectas.', 'error');
            }
        });

        // V2: Botón Cancelar Login
        cancelLoginBtn.addEventListener('click', () => {
             // ** CORRECCIÓN: Cerrar sesión del cliente si estaba abierta, por si el negocio cancela el cobro. **
             signOut(auth).catch(() => {});
             resetChargeState();
             showMessage('Transacción cancelada por el negocio.', 'info');
        });

        // V3: Confirmación de Pago
        confirmPaymentBtn.addEventListener('click', async () => {
            const customerUser = auth.currentUser;
            if (!customerUser || chargeAmount <= 0) {
                showCompletionScreen(false, 'Error', 'No hay un cliente autenticado o un monto válido.');
                return;
            }
            if (!businessUser) {
                 showCompletionScreen(false, 'Error', 'Sesión del negocio perdida. Por favor, reinicie.');
                 return;
            }
            
            const customerId = customerUser.uid;
            const businessId = businessUser.uid; 
            
            const customerRef = doc(db, `artifacts/${appId}/users/${customerId}/account/data`);
            const businessRef = doc(db, `artifacts/${appId}/users/${businessId}/account/data`);

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Obtener documentos de cuentas
                    const customerDoc = await transaction.get(customerRef);
                    if (!customerDoc.exists()) throw new Error("Cuenta del cliente no existe.");
                    
                    const businessDoc = await transaction.get(businessRef);
                    
                    // 2. Lógica de transferencia y balance
                    const customerBalance = customerDoc.data().balance;
                    if (customerBalance < chargeAmount) {
                        throw new Error("Saldo insuficiente en la cuenta del cliente.");
                    }

                    const newCustomerBalance = customerBalance - chargeAmount;
                    let currentBusinessBalance = businessDoc.exists() ? businessDoc.data().balance : 0;
                    const newBusinessBalance = currentBusinessBalance + chargeAmount;

                    // 3. Actualizar saldos
                    
                    // A. Cliente: Update
                    transaction.update(customerRef, { balance: newCustomerBalance });

                    // B. Negocio: SET (Crea si no existe, actualiza si existe)
                    if (!businessDoc.exists()) {
                         // Crea el documento del negocio con el nuevo balance si no existía
                         transaction.set(businessRef, { 
                            balance: newBusinessBalance, 
                            name: businessUser.name, 
                            email: customerUser.email, 
                            creditScore: { average: 5.0, count: 0 } 
                         });
                    } else {
                        // Actualiza el documento del negocio si ya existía
                        transaction.update(businessRef, { balance: newBusinessBalance });
                    }
                });

                // 4. Registro de transacciones 
                const customerData = await getAccountData(customerId);

                // A. Cliente: Gasto (Negativo)
                await createTransaction(customerId, { 
                    amount: chargeAmount, 
                    senderId: customerId, 
                    recipientId: businessId,
                    type: 'pos-payment-sent', 
                    senderName: customerData.name,
                    recipientName: businessUser.name
                });
                // B. Negocio: Ingreso (Positivo)
                await createTransaction(businessId, { 
                    amount: chargeAmount, 
                    senderId: customerId, 
                    recipientId: businessId,
                    type: 'pos-payment-received', 
                    senderName: customerData.name,
                    recipientName: businessUser.name
                });
                
                // showCompletionScreen ahora cierra la sesión de Firebase
                showCompletionScreen(true, '¡Pago Exitoso!', `Se cobró $${chargeAmount.toFixed(2)} al cliente y se acreditó al negocio. UID del Negocio: **${businessId}**`);

            } catch (e) {
                console.error("Fallo de Transacción:", e.message);
                let msg = e.message.includes("Saldo insuficiente") 
                    ? "Saldo insuficiente para completar el cobro."
                    : `Fallo la transacción: ${e.message}`;
                // showCompletionScreen ahora cierra la sesión de Firebase
                showCompletionScreen(false, 'Pago Fallido', msg);
            }
        });
        
        // V3: Botón Cancelar Pago
        cancelPaymentBtn.addEventListener('click', () => {
             // showCompletionScreen ahora se encarga de cerrar la sesión del cliente
             showCompletionScreen(false, 'Transacción Cancelada', 'El cliente decidió cancelar el pago.');
        });
        
        // V4: Botón Nueva Transacción
        newTransactionBtn.addEventListener('click', () => {
             // Dado que showCompletionScreen cerró la sesión, solo necesitamos resetear el estado de cobro
             resetChargeState(); 
        });


        // --- CONTROL DE ESTADO DE AUTENTICACIÓN ---
        
        onAuthStateChanged(auth, async (user) => {
            // Maneja el estado cuando el cliente o el negocio inicia sesión (o se refresca la página)
            
            if (user && businessUser && user.uid === businessUser.uid) {
                // Estado: El negocio está logueado (solo sucede por recarga de página)
                document.getElementById('business-name-display').textContent = user.displayName || businessUser.name;
                businessUser.name = user.displayName || businessUser.name; // Actualizar el nombre si es necesario
                switchView('charge-setup');
                
            } else if (user && businessUser && user.uid !== businessUser.uid) {
                // Estado: El cliente está logueado y el negocio tiene su ID guardado
                if (chargeAmount > 0) {
                     // Solo saltar a confirmación si ya se definió un monto
                    document.getElementById('customer-name-display').textContent = user.displayName || 'Cliente';
                    const balance = await loadBalance(user.uid);
                    document.getElementById('display-current-balance').textContent = `$${balance.toFixed(2)}`;
                    switchView('payment-confirmation');
                } else {
                     // El cliente anterior sigue logueado, pero no hay cobro activo. Volver a la configuración del negocio.
                     // CERRAR SESIÓN DEL CLIENTE ANTERIOR PARA EVITAR CONFUSIONES
                     signOut(auth).catch(() => {});
                     switchView('charge-setup');
                }
            } else {
                 // Estado: Nadie está logueado (al inicio, o después de cerrar sesión de negocio o cliente)
                 if (!businessUser) {
                    // Si no hay negocio guardado, pedir login de negocio
                    switchView('business-login');
                 } else {
                    // Si businessUser existe pero auth.currentUser no, (estado normal de espera)
                    switchView('charge-setup');
                 }
            }
        });
        
        // Iniciar en la vista de login del negocio
        switchView('business-login'); 

    </script>
</body>
</html>
