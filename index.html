<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="bank.png" />
    <title>HUG Bank - Tu Banco Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* [Se mantiene todo el bloque de estilos CSS] */
        :root {
            --hug-primary: #007bff;
            --hug-secondary: #f3f4f6;
            --hug-text-color: #1f2937;
            --hug-header: #3b82f6;
        }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacs, sans-serif;
            background-color: var(--hug-secondary);
            color: var(--hug-text-color);
        }
        .bg-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: var(--hug-primary);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Blue-600 */
        }
        .btn-secondary {
            background-color: #e5e7eb; /* Gray-200 */
            color: var(--hug-text-color);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .transaction-item:hover {
            background-color: #f7f9fb;
        }
        .header-bar {
            background-color: var(--hug-header);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem 0.75rem 0 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        /* Estilos para el modal/overlay */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border-radius: 0.5rem;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .star-rating label {
            font-size: 2rem;
            color: #ccc;
            cursor: pointer;
        }
        .star-rating input:checked ~ label {
            color: #ffc107;
        }
        .star-rating input {
            display: none;
        }
        .star-rating {
            direction: rtl;
            display: inline-block;
        }
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #ffc107;
        }

    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 md:p-8">

    <div id="app" class="w-full max-w-5xl">
        
        <div id="dashboard-view" class="hidden bg-card p-0">
            
            <div class="header-bar flex flex-col md:flex-row justify-between items-start md:items-center space-y-3 md:space-y-0">
                <div class="flex-shrink-0">
                    <h1 class="text-2xl font-extrabold">
                        <img src="bank.svg" alt="HUG Bank Logo" class="inline h-16 w-16 mr-2 align-middle">
                        <span class="text-white">HUG</span> - <span class="text-blue-200">Bank</span>
                    </h1>
                    <p class="text-sm font-medium mt-1">Bienvenido, <span id="user-name-display" class="font-bold">Usuario</span></p>
                    <p class="text-xs text-blue-200 mt-0 break-all">ID: <span id="user-id-display">...</span></p>
                    <p class="text-xs text-blue-200 mt-0">Crédito: <span id="credit-score-display" class="font-bold text-white">N/A</span></p>
                </div>

                <div class="flex flex-row space-x-4 w-full md:w-auto">
                    <button id="show-transfer-btn" class="flex-1 py-2 px-4 rounded-full text-md font-semibold text-white btn-primary">
                        Transferir / Prestar
                    </button>
                    <button id="logout-btn" class="flex-1 py-2 px-4 rounded-full text-md font-semibold btn-secondary">
                        Cerrar Sesión
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6 md:p-8">
                
                <div class="lg:col-span-1 space-y-6">
                    
                    <div class="bg-blue-50 p-6 rounded-xl border border-blue-200 text-center">
                        <p class="text-sm text-blue-600">Saldo actual</p>
                        <h3 class="text-4xl font-extrabold mt-1 text-hug-text-color" id="balance-display">$0.00</h3>
                    </div>

                    <div class="bg-card p-5 border border-gray-100">
                        <h3 class="text-xl font-bold mb-4">Deudas y Ofertas</h3>
                        <div id="debts-list" class="space-y-4">
                            <p class="text-gray-500 text-sm">Cargando...</p>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div class="bg-card p-5 border border-gray-100 h-full">
                        <h3 class="text-xl font-bold mb-4">Historial Completo</h3>
                        <div id="transactions-list" class="space-y-3 max-h-96 lg:max-h-[600px] overflow-y-auto pr-2">
                            <p class="text-gray-500 text-sm">Cargando historial...</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="transfer-view" class="hidden bg-card p-6 md:p-8 max-w-md mx-auto mt-16">
            <h2 class="text-2xl font-bold mb-4">Enviar o Prestar</h2>

            <form id="transfer-form" class="space-y-4">
                <div>
                    <label for="recipient-id" class="block text-sm font-medium">ID del Receptor</label>
                    <input type="text" id="recipient-id" required placeholder="ID completo del usuario"
                           class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="amount" class="block text-sm font-medium">Monto</label>
                    <input type="number" id="amount" required min="1" step="0.01" placeholder="Ej: 50.00"
                           class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="transaction-type" class="block text-sm font-medium">Tipo de Transacción</label>
                    <select id="transaction-type" class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="transfer">Transferencia</option>
                        <option value="loan">Préstamo</option>
                    </select>
                </div>
                
                <div id="interest-rate-field" class="hidden">
                    <label for="interest" class="block text-sm font-medium">Interés (%)</label>
                    <input type="number" id="interest" min="0" step="0.01" value="5"
                           class="mt-1 block w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>

                <button type="submit" class="w-full py-3 px-4 rounded-full text-lg font-semibold text-white btn-primary">
                    Confirmar
                </button>
            </form>

            <button id="back-to-dashboard-btn" class="w-full mt-4 py-3 px-4 rounded-full text-lg font-semibold btn-secondary">
                Volver
            </button>
        </div>

        <div id="message-box" class="mt-4 p-4 rounded-lg text-sm hidden" role="alert"></div>

    </div>
    
    <div id="score-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 class="text-xl font-bold mb-4">Puntuar Deudor</h3>
            <p class="mb-4">Califica el comportamiento de pago de <span id="score-modal-recipient-name" class="font-semibold"></span> (ID: <span id="score-modal-recipient-id" class="text-sm"></span>)</p>
            
            <form id="score-form" data-loan-doc-id="" data-recipient-id="">
                 <div class="flex justify-center mb-6">
                    <div class="star-rating">
                        <input type="radio" id="star5" name="rating" value="5" required /><label for="star5" title="5 estrellas">★</label>
                        <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 estrellas">★</label>
                        <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 estrellas">★</label>
                        <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 estrellas">★</label>
                        <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 estrella">★</label>
                    </div>
                 </div>
                <button type="submit" class="w-full py-2 px-4 rounded-full text-md font-semibold text-white btn-primary">
                    Enviar Puntuación
                </button>
            </form>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Se mantiene getAuth, pero solo para signOut y onAuthStateChanged
        import { getAuth, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, runTransaction, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE ---
        const demoFirebaseConfig = {
            apiKey: "AIzaSyBedGoV0Lp_i0Z2wo1_0SkaJa_NrZTPN2g",
            authDomain: "hug-bank.firebaseapp.com",
            projectId: "hug-bank",
            storageBucket: "hug-bank.firebasestorage.app",
            messagingSenderId: "891285624181",
            appId: "1:891285624181:web:c37e3a50275353af88af3c",
            measurementId: "G-5HDSRH2SB2"
        };
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : demoFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null; 

        // --- REFERENCIAS DE UI ---
        const views = {
            dashboard: document.getElementById('dashboard-view'),
            transfer: document.getElementById('transfer-view')
        };
        const messageBox = document.getElementById('message-box');
        const transactionTypeSelect = document.getElementById('transaction-type');
        const interestRateField = document.getElementById('interest-rate-field');
        const transactionsList = document.getElementById('transactions-list');
        const debtsList = document.getElementById('debts-list'); 
        const creditScoreDisplay = document.getElementById('credit-score-display'); 

        // Referencias del Modal de Puntuación
        const scoreModal = document.getElementById('score-modal');
        const closeBtn = document.querySelector('.close-btn');
        const scoreForm = document.getElementById('score-form');
        const scoreModalRecipientName = document.getElementById('score-modal-recipient-name');
        const scoreModalRecipientId = document.getElementById('score-modal-recipient-id');


        // --- UTILIDADES ---
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = 'mt-4 p-4 rounded-lg text-sm transition-all duration-300';
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'info') {
                 messageBox.classList.add('bg-blue-100', 'text-blue-800');
            }
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        function switchView(target) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            views[target].classList.remove('hidden');
        }

        // --- LÓGICA DEL MODAL DE PUNTUACIÓN ---
        closeBtn.onclick = () => { scoreModal.style.display = 'none'; };
        window.onclick = (event) => {
            if (event.target === scoreModal) {
                scoreModal.style.display = 'none';
            }
        };

        scoreForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const rating = parseInt(document.querySelector('input[name="rating"]:checked').value);
            const loanDocId = scoreForm.getAttribute('data-loan-doc-id');
            const recipientId = scoreForm.getAttribute('data-recipient-id');
            
            try {
                // 1. Se puntúa la deuda y el deudor
                await saveCreditScore(recipientId, rating);
                // 2. Se marca la transacción de prestamista como puntuado para no volver a salir el botón.
                await updateDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/transactions/${loanDocId}`), { 
                    scoreGiven: true, 
                    score: rating 
                });
                
                showMessage('Puntuación enviada con éxito.', 'success');
                scoreModal.style.display = 'none';
                // Recargar el saldo y las transacciones para actualizar la UI
                loadBalance(currentUser.uid);
                listenToTransactions(currentUser.uid); // Forzar recarga de transacciones
            } catch (error) {
                console.error("Error al enviar puntuación:", error);
                showMessage(`Error al enviar puntuación: ${error.message}`, 'error');
            }
        });

        // --- MANEJO DE VISTAS Y EVENTOS ---
        
        document.getElementById('show-transfer-btn').addEventListener('click', () => {
            switchView('transfer');
        });

        document.getElementById('back-to-dashboard-btn').addEventListener('click', () => {
            switchView('dashboard');
        });

        transactionTypeSelect.addEventListener('change', (e) => {
            interestRateField.classList.toggle('hidden', e.target.value !== 'loan');
        });

        // --- FIREBASE AUTH Y ESTADO ---
        
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                // Redirigir al usuario al login
                window.location.href = './login'; 
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showMessage('Error al cerrar sesión.', 'error');
            }
        });

        // Este bloque detecta si hay un usuario logueado con cuenta
        onAuthStateChanged(auth, async (user) => {
            if (user && !user.isAnonymous) { // Solo usuarios autenticados con cuenta
                currentUser = user;
                document.getElementById('user-id-display').textContent = user.uid;
                document.getElementById('user-name-display').textContent = user.displayName || 'Usuario';
                loadBalance(user.uid);
                loadCreditScore(user.uid); // Cargar puntuación de crédito
                listenToTransactions(user.uid);
                switchView('dashboard');
            } else if (user && user.isAnonymous) {
                // Si el usuario es anónimo (solo para entorno), forzar redirección al login
                await signOut(auth);
                window.location.href = './login';
            } else {
                currentUser = null;
                // Si no hay usuario, redirigir al login.
                window.location.href = './login'; 
            }
        });

        // --- FUNCIONES FIRESTORE (Se mantienen) ---
        
        async function loadBalance(userId) {
            if (!userId) return;
            const balanceDisplay = document.getElementById('balance-display');
            try {
                const userAccountRef = doc(db, `artifacts/${appId}/users/${userId}/account/data`);
                const docSnap = await getDoc(userAccountRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const balance = data.balance;
                    balanceDisplay.textContent = `$${balance.toFixed(2)}`;
                } else {
                    // Si llega aquí sin cuenta, debería ser un error, pero forzamos la inicialización
                    await setDoc(userAccountRef, { balance: 0.00, name: currentUser.displayName || 'Anónimo', email: currentUser.email || 'N/A', creditScore: { average: 5.0, count: 0 } });
                    balanceDisplay.textContent = '$0.00';
                }
            } catch (error) {
                console.error("Error al cargar el saldo:", error);
                balanceDisplay.textContent = 'Error';
            }
        }
        
        async function loadCreditScore(userId) {
             if (!userId) return;
             try {
                const userAccountRef = doc(db, `artifacts/${appId}/users/${userId}/account/data`);
                const docSnap = await getDoc(userAccountRef);
                if (docSnap.exists() && docSnap.data().creditScore) {
                    const score = docSnap.data().creditScore;
                    const rating = score.average.toFixed(1);
                    creditScoreDisplay.textContent = `${rating} ★ (${score.count})`;
                } else {
                    creditScoreDisplay.textContent = '5.0 ★ (0)';
                }
            } catch (error) {
                console.error("Error al cargar la puntuación de crédito:", error);
                creditScoreDisplay.textContent = 'Error';
            }
        }

        async function getAccountData(userId) {
             const userAccountRef = doc(db, `artifacts/${appId}/users/${userId}/account/data`);
             const docSnap = await getDoc(userAccountRef);
             if (docSnap.exists()) return docSnap.data();
             return null;
        }

        async function createTransaction(userId, transactionData) {
            const transactionsRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
            return await addDoc(transactionsRef, { ...transactionData, timestamp: serverTimestamp() });
        }
        
        // --- FUNCIÓN ADICIONAL: Cancelar Préstamo por Prestamista ---
        async function cancelLoanByLender(lenderTransactionId, recipientId) {
            if (!currentUser) return;
            const lenderId = currentUser.uid;
            
            // 1. Encontrar el documento 'loan-sent' del prestamista
            const lenderDocRef = doc(db, `artifacts/${appId}/users/${lenderId}/transactions/${lenderTransactionId}`);
            const lenderDocSnap = await getDoc(lenderDocRef);
            if (!lenderDocSnap.exists() || lenderDocSnap.data().status !== 'completed') {
                throw new Error("Transacción del prestamista no válida o no completada.");
            }
            const loanData = lenderDocSnap.data();
            
            // 2. Buscar el documento 'loan-debt' correspondiente del deudor.
            // Buscamos la DEUDA PENDIENTE que tiene como referencia al loan-sent
            const debtQuery = query(
                collection(db, `artifacts/${appId}/users/${recipientId}/transactions`),
                where('type', '==', 'loan-debt'),
                where('senderTransactionId', '==', lenderTransactionId),
                where('status', '==', 'pending')
            );
            // Ejecutamos la consulta (CORRECCIÓN: Usar getDocs en un Query)
            const debtSnapshot = await getDocs(debtQuery);
            const debtDoc = debtSnapshot.docs.length > 0 ? debtSnapshot.docs[0] : null;
            const debtDocRef = debtDoc ? doc(db, `artifacts/${appId}/users/${recipientId}/transactions/${debtDoc.id}`) : null;

            // 3. Iniciar Transacción
            try {
                await runTransaction(db, async (transaction) => {
                    // Monto total del préstamo
                    const amountToPay = loanData.originalAmount * (1 + loanData.interestRate / 100);

                    // 3.1. Marcar el 'loan-sent' del prestamista como pagado (completed-paid)
                    transaction.update(lenderDocRef, { status: 'completed-paid', paidAmount: amountToPay, paidDate: serverTimestamp() });
                    
                    // 3.2. Marcar el 'loan-debt' del deudor como pagado, si existe.
                    if (debtDocRef) {
                        transaction.update(debtDocRef, { status: 'paid-by-lender', paidAmount: amountToPay, paidDate: serverTimestamp() });
                    }
                });

                // 4. Crear transacciones de historial
                const amountToPay = loanData.originalAmount * (1 + loanData.interestRate / 100);
                const recipientData = await getAccountData(recipientId);
                const lenderData = await getAccountData(lenderId);

                 // Registrar el cobro en el historial del prestamista (Entrada de dinero por la cancelación)
                await createTransaction(lenderId, {
                    amount: amountToPay,
                    senderId: recipientId, // Quien debería haber pagado
                    recipientId: lenderId,
                    type: 'loan-paid-cancellation', // Entrada de dinero (Cobro de préstamo por cancelación)
                    originalLoanId: lenderTransactionId,
                    interestRate: loanData.interestRate,
                    senderName: recipientData.name,
                    recipientName: lenderData.name
                }); 
                 // Registrar el pago en el historial del deudor (Salida de dinero - Negativo, solo historial, no afecta saldo)
                await createTransaction(recipientId, {
                    amount: amountToPay,
                    senderId: lenderId,
                    recipientId: recipientId,
                    type: 'loan-payment-lender-cancellation', // El deudor no movió dinero, solo se registra el pago forzado.
                    originalLoanId: debtDoc ? debtDoc.id : 'N/A',
                    interestRate: loanData.interestRate,
                    senderName: lenderData.name,
                    recipientName: recipientData.name
                }); 

                showMessage('Préstamo marcado como PAGADO. Ahora puedes puntuar al deudor.', 'success');
                loadBalance(lenderId);
                listenToTransactions(lenderId); // Forzar recarga de transacciones
            } catch (e) {
                console.error("Fallo al cancelar préstamo:", e);
                showMessage(`Fallo al cancelar el préstamo: ${e.message}`, 'error');
            }
        }
        
        // --- FUNCIÓN ADICIONAL: Guardar Puntuación de Crédito ---
        async function saveCreditScore(recipientId, score) {
            if (!currentUser) throw new Error("Usuario no autenticado.");
            
            const recipientAccountRef = doc(db, `artifacts/${appId}/users/${recipientId}/account/data`);

            await runTransaction(db, async (transaction) => {
                const recipientDoc = await transaction.get(recipientAccountRef);
                if (!recipientDoc.exists()) throw new Error("Cuenta del deudor no encontrada.");

                const data = recipientDoc.data();
                const currentScore = data.creditScore || { average: 5.0, count: 0 };
                
                // Nuevo cálculo del promedio
                const newTotal = (currentScore.average * currentScore.count) + score;
                const newCount = currentScore.count + 1;
                const newAverage = newTotal / newCount;

                // Actualizar el perfil del deudor
                transaction.update(recipientAccountRef, { 
                    creditScore: {
                        average: newAverage,
                        count: newCount
                    }
                });
            });
            // Recargar el score del prestamista, en caso de que sea el mismo, aunque no es su score.
            loadCreditScore(recipientId);
        }


        // --- MANEJO DE TRANSFERENCIAS Y PRÉSTAMOS ---
        document.getElementById('transfer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { showMessage('Debes iniciar sesión para transferir.', 'error'); return; }

            const recipientId = document.getElementById('recipient-id').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            const transactionType = transactionTypeSelect.value;
            const interest = parseFloat(document.getElementById('interest').value);
            const senderId = currentUser.uid;

            if (senderId === recipientId) { showMessage('No puedes transferir a tu propia cuenta.', 'error'); return; }
            if (amount <= 0 || isNaN(amount)) { showMessage('Monto no válido.', 'error'); return; }

            // NUEVO: Obtener el score del receptor para el check de préstamo
            if (transactionType === 'loan') {
                 const recipientData = await getAccountData(recipientId);
                 if (!recipientData) { showMessage('ID del receptor no encontrado.', 'error'); return; }
                 
                 const rScore = recipientData.creditScore.average.toFixed(1);
                 const rCount = recipientData.creditScore.count;
                 
                 // Uso de confirm() como única excepción de diálogo de confirmación de flujo de negocio
                 if (!confirm(`El receptor (${recipientData.name}) tiene un Score de ${rScore} ★ (${rCount} votos). ¿Deseas continuar con el préstamo de $${amount.toFixed(2)} al ${interest}%?`)) {
                     showMessage('Oferta de préstamo cancelada por el prestamista.', 'info'); return;
                 }
            }


            const senderRef = doc(db, `artifacts/${appId}/users/${senderId}/account/data`);
            const recipientRef = doc(db, `artifacts/${appId}/users/${recipientId}/account/data`);

            try {
                const senderData = await getAccountData(senderId);
                const recipientData = await getAccountData(recipientId);

                if (transactionType === 'loan') {
                    // Lógica para Oferta de Préstamo (Aún no se mueve el dinero)
                    const loanData = { 
                        amount: amount,
                        senderId: senderId,
                        recipientId: recipientId,
                        interestRate: interest,
                        originalAmount: amount,
                        status: 'pending-offer',
                        recipientName: recipientData ? recipientData.name : 'Desconocido'
                    };

                    // Verificar que el remitente tenga saldo para la OFERTA
                    const senderDoc = await getDoc(senderRef);
                    if (!senderDoc.exists() || senderDoc.data().balance < amount) {
                        throw new Error("Saldo insuficiente para enviar la oferta de préstamo.");
                    }

                    // 1. Prestamista (Registra la salida potencial de dinero - tipo: loan-sent)
                    const loanSentDoc = await createTransaction(senderId, { 
                        ...loanData, 
                        type: 'loan-sent',
                        scoreGiven: false // Nuevo campo para saber si ya se puntuó
                    }); 

                    // 2. Deudor (Registra la OFERTA que debe ACEPTAR/RECHAZAR - tipo: loan-offer)
                    await createTransaction(recipientId, { 
                        ...loanData, 
                        type: 'loan-offer', 
                        senderTransactionId: loanSentDoc.id,
                        lenderName: senderData ? senderData.name : 'Anónimo'
                    }); 
                    
                    showMessage('Oferta de préstamo enviada. El receptor debe aceptarla.', 'success');

                } else {
                    // Lógica para Transferencia Directa (Mover dinero inmediatamente)
                    await runTransaction(db, async (transaction) => {
                        const senderDoc = await transaction.get(senderRef);
                        if (!senderDoc.exists()) throw new Error("Documento remitente no existe.");
                        
                        const recipientDoc = await transaction.get(recipientRef);
                        if (!recipientDoc.exists()) throw new Error("Documento receptor no existe. Verifica el ID.");

                        const senderBalance = senderDoc.data().balance;
                        if (senderBalance < amount) throw new Error("Saldo insuficiente.");

                        const newSenderBalance = senderBalance - amount;
                        const newRecipientBalance = recipientDoc.data().balance + amount;

                        transaction.update(senderRef, { balance: newSenderBalance });
                        transaction.update(recipientRef, { balance: newRecipientBalance });
                    });
                    
                    const baseTransferData = { 
                        amount, 
                        senderId, 
                        recipientId, 
                        senderName: senderData ? senderData.name : 'Anónimo',
                        recipientName: recipientData ? recipientData.name : 'Desconocido'
                    };
                    // Historial del Remitente (Negativo)
                    await createTransaction(senderId, { ...baseTransferData, type: 'transfer-sent' });
                    // Historial del Receptor (Positivo)
                    await createTransaction(recipientId, { ...baseTransferData, type: 'transfer-received' });
                    
                    showMessage('Transferencia exitosa.', 'success');
                }
                
                switchView('dashboard');
                loadBalance(senderId);
            } catch (e) {
                console.error("Fallo de Transacción: ", e.message);
                showMessage(`Fallo la transferencia: ${e.message}`, 'error');
            }
        });
        
        // --- REEMBOLSO DE PRÉSTAMO (Pago) ---
        async function payLoan(loanDocId, loanData) {
            if (!currentUser) return;
            // Cálculo del monto total a pagar (Capital + Interés)
            const amountToPay = loanData.originalAmount * (1 + loanData.interestRate / 100); 
            
            const payerId = currentUser.uid; // El usuario que paga (el deudor)
            const recipientId = loanData.senderId; // El usuario que recibe (el prestamista original)

            const payerRef = doc(db, `artifacts/${appId}/users/${payerId}/account/data`);
            const recipientRef = doc(db, `artifacts/${appId}/users/${recipientId}/account/data`);
            // El documento de deuda que se va a marcar como pagado (es el documento loan-debt del deudor)
            const loanDocRef = doc(db, `artifacts/${appId}/users/${payerId}/transactions/${loanDocId}`); 
            // El documento 'loan-sent' del prestamista que se va a marcar como pagado
            const senderLoanSentRef = doc(db, `artifacts/${appId}/users/${recipientId}/transactions/${loanData.senderTransactionId}`);


            try {
                await runTransaction(db, async (transaction) => {
                    const payerDoc = await transaction.get(payerRef);
                    if (!payerDoc.exists()) throw new Error("Documento de la cuenta de pago no existe.");

                    const payerBalance = payerDoc.data().balance;
                    if (payerBalance < amountToPay) throw new Error("Saldo insuficiente para pagar el préstamo.");

                    const newPayerBalance = payerBalance - amountToPay;
                    const newRecipientBalance = (await transaction.get(recipientRef)).data().balance + amountToPay;

                    // 1. Actualizar saldos
                    transaction.update(payerRef, { balance: newPayerBalance });
                    transaction.update(recipientRef, { balance: newRecipientBalance });
                    
                    // 2. Marcar deuda como pagada en el historial del deudor (esto hace desaparecer el botón Pagar)
                    transaction.update(loanDocRef, { status: 'paid', paidAmount: amountToPay, paidDate: serverTimestamp() });
                    
                    // 3. Marcar la transacción del prestamista como pagada
                    transaction.update(senderLoanSentRef, { status: 'completed-paid', paidAmount: amountToPay, paidDate: serverTimestamp() });
                });
                
                const payerData = await getAccountData(payerId);
                const recipientData = await getAccountData(recipientId);

                // 4. Registrar el pago en el historial del deudor (Salida de dinero - Negativo)
                const paymentData = {
                    amount: amountToPay,
                    senderId: payerId,
                    recipientId: recipientId,
                    type: 'loan-payment', // Salida de dinero por pago de deuda (NEGATIVO)
                    originalLoanId: loanDocId,
                    interestRate: loanData.interestRate,
                    senderName: payerData.name,
                    recipientName: recipientData.name
                };
                await createTransaction(payerId, paymentData); 

                // 5. Registrar el pago en el historial del prestamista (Entrada de dinero - Positivo)
                const receivedData = {
                    amount: amountToPay,
                    senderId: payerId,
                    recipientId: recipientId,
                    type: 'loan-paid', // Entrada de dinero (Cobro de préstamo)
                    originalLoanId: loanDocId,
                    interestRate: loanData.interestRate,
                    senderName: payerData.name,
                    recipientName: recipientData.name
                };
                await createTransaction(recipientId, receivedData); 

                showMessage('Préstamo pagado exitosamente. El prestamista ahora puede puntuar tu comportamiento.', 'success');
                loadBalance(payerId);
            } catch (e) {
                console.error("Fallo de pago de préstamo:", e);
                showMessage(`Fallo al pagar el préstamo: ${e.message}`, 'error');
            }
        }

        // --- MANEJO DE OFERTAS DE PRÉSTAMO ---

        async function acceptLoanOffer(offerDocId, offerData) {
            if (!currentUser) return;
            const recipientId = currentUser.uid;
            const senderId = offerData.senderId;
            const amount = offerData.amount;

            const senderRef = doc(db, `artifacts/${appId}/users/${senderId}/account/data`);
            const recipientRef = doc(db, `artifacts/${appId}/users/${recipientId}/account/data`);
            const offerDocRef = doc(db, `artifacts/${appId}/users/${recipientId}/transactions/${offerDocId}`);
            
            // La transacción del prestamista (que ya se creó) para marcarla como exitosa
            const senderLoanSentRef = doc(db, `artifacts/${appId}/users/${senderId}/transactions/${offerData.senderTransactionId}`);
            
            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Mover el dinero
                    const senderDoc = await transaction.get(senderRef);
                    const recipientDoc = await transaction.get(recipientRef);

                    // Re-verificación de saldo del prestamista (sender)
                    if (!senderDoc.exists() || senderDoc.data().balance < amount) {
                         // Si el saldo ya no está, se rechaza la operación.
                         throw new Error("El prestamista ya no tiene el saldo disponible. Oferta cancelada.");
                    }

                    const newSenderBalance = senderDoc.data().balance - amount;
                    const newRecipientBalance = recipientDoc.data().balance + amount;

                    transaction.update(senderRef, { balance: newSenderBalance });
                    transaction.update(recipientRef, { balance: newRecipientBalance });

                    // 2. Marcar la OFERTA como ACEPTADA en el historial del deudor
                    transaction.update(offerDocRef, { status: 'accepted' });
                    
                    // 3. Actualizar el estado del 'loan-sent' del prestamista a 'completed'
                    transaction.update(senderLoanSentRef, { status: 'completed' });
                });

                // --- ACCIONES FUERA DE LA TRANSACCIÓN DE SALDO ---
                const senderData = await getAccountData(senderId);
                const recipientData = await getAccountData(recipientId);

                const loanBaseData = {
                    ...offerData,
                    senderName: senderData.name,
                    recipientName: recipientData.name,
                    senderTransactionId: offerData.senderTransactionId // Reutilizar el ID del prestamista
                };

                // 4. Registrar la DEUDA OFICIAL (loan-debt) en el historial del deudor (NECESARIO PARA EL BOTÓN PAGAR)
                // Se crea un nuevo documento solo para rastrear la deuda y el pago.
                await createTransaction(recipientId, { ...loanBaseData, type: 'loan-debt', status: 'pending' });
                
                // 5. Registrar el INGRESO de dinero (loan-received) en el historial del deudor
                await createTransaction(recipientId, { ...loanBaseData, type: 'loan-received', status: 'completed' });
                
                showMessage('Oferta de préstamo aceptada. El dinero se ha depositado en tu cuenta.', 'success');
                loadBalance(recipientId);

            } catch (e) {
                console.error("Fallo al aceptar préstamo:", e);
                // Si falla el movemos el dinero, actualizamos el status del prestamista a fallido/rechazado
                // Intentar actualizar el estado del prestamista, ignorando errores menores
                try { await updateDoc(senderLoanSentRef, { status: 'failed-rejected' }); } catch(err) { console.warn("No se pudo actualizar estado de prestamista", err); }
                showMessage(`Fallo al aceptar la oferta: ${e.message}`, 'error');
            }
        }
        
        async function rejectLoanOffer(offerDocId, offerData) {
            if (!currentUser) return;
            const recipientId = currentUser.uid;
            
            const offerDocRef = doc(db, `artifacts/${appId}/users/${recipientId}/transactions/${offerDocId}`);
            
            // La transacción del prestamista (que ya se creó) para marcarla como rechazada
            const senderLoanSentRef = doc(db, `artifacts/${appId}/users/${offerData.senderId}/transactions/${offerData.senderTransactionId}`);

            try {
                // 1. Marcar la OFERTA como RECHAZADA en el historial del deudor
                await updateDoc(offerDocRef, { status: 'rejected' });

                // 2. Marcar la transacción 'loan-sent' del prestamista como 'rejected'
                await updateDoc(senderLoanSentRef, { status: 'rejected' }); 
                
                showMessage('Oferta de préstamo rechazada.', 'info');
            } catch (e) {
                console.error("Fallo al rechazar préstamo:", e);
                showMessage(`Fallo al rechazar la oferta: ${e.message}`, 'error');
            }
        }


        // --- HISTORIAL DE TRANSACCIONES (Ambas Listas) ---
        function listenToTransactions(userId) {
            const transactionsRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
            const q = query(transactionsRef, orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snapshot) => {
                transactionsList.innerHTML = '';
                debtsList.innerHTML = ''; // Limpiar la lista de deudas/ofertas
                let hasActiveDebtsOrOffers = false;

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center py-3 px-4 rounded-lg bg-card border border-gray-100 transaction-item';
                    
                    let description = '';
                    let amountClass = '';
                    let amountSign = '';
                    let amountDisplay = data.amount ? data.amount.toFixed(2) : (data.paidAmount ? data.paidAmount.toFixed(2) : '0.00');
                    let actionButtonsHtml = '';
                    let shouldGoToDebtsList = false;
                    
                    // --- Lógica de Tipos de Transacción ---
                    
                    if (data.type === 'transfer-sent') {
                        description = `Transferencia enviada a ${data.recipientName || 'Desconocido'}`;
                        amountClass = 'text-red-500'; amountSign = '-';
                    } else if (data.type === 'transfer-received') {
                        description = `Transferencia recibida de ${data.senderName || 'Desconocido'}`;
                        amountClass = 'text-green-500'; amountSign = '+';
                    } else if (data.type === 'loan-sent') {
                        // Salida de dinero por préstamo otorgado (PRESTAMISTA)
                        let statusText = 'Pendiente';
                        if (data.status === 'completed') {
                            statusText = 'Aceptado. Esperando pago.';
                            // Botón de Cancelación/Pago por Prestamista
                            actionButtonsHtml += `<button class="cancel-loan-btn bg-yellow-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-yellow-600 mr-2" data-id="${doc.id}" data-recipient-id="${data.recipientId}">Marcar Pagado</button>`;
                        } else if (data.status === 'completed-paid') { 
                            statusText = 'Pagado/Cancelado.';
                            // Botón de Puntuación
                            if (!data.scoreGiven) {
                                actionButtonsHtml += `<button class="score-btn bg-blue-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-blue-600" data-id="${doc.id}" data-recipient-id="${data.recipientId}" data-recipient-name="${data.recipientName}">Puntuar Deudor</button>`;
                            } else {
                                actionButtonsHtml += `<span class="text-xs text-white bg-green-700 px-2 py-1 rounded-full">Puntuado: ${data.score} ★</span>`;
                            }
                        } else if (data.status === 'rejected' || data.status === 'failed-rejected') {
                            statusText = 'Rechazado/Fallido';
                        }
                        
                        description = `Préstamo a ${data.recipientName || 'Desconocido'} (Estado: ${statusText})`;
                        amountClass = data.status === 'completed' || data.status === 'completed-paid' ? 'text-red-500' : 'text-gray-500'; 
                        amountSign = data.status === 'completed' || data.status === 'completed-paid' ? '-' : '';
                        amountDisplay = data.originalAmount.toFixed(2);

                    } else if (data.type === 'loan-payment') {
                        // Pago realizado por el DEUDOR
                        description = `Pago de Préstamo a ${data.recipientName || 'Desconocido'} (Int: ${data.interestRate}%)`;
                        amountDisplay = data.amount.toFixed(2);
                        amountClass = 'text-red-500'; amountSign = '-';
                    } else if (data.type === 'loan-paid' || data.type === 'loan-paid-cancellation') {
                        // Cobro recibido por el PRESTAMISTA
                        description = `Cobro de Préstamo de ${data.senderName || 'Desconocido'} (Int: ${data.interestRate}%)`;
                        amountDisplay = data.amount.toFixed(2);
                        amountClass = 'text-green-500'; amountSign = '+';
                    } else if (data.type === 'loan-offer') {
                        // Oferta de préstamo (Solo muestra los botones para ACEPTAR/RECHAZAR)
                        description = `OFERTA de ${data.lenderName || 'Anónimo'} $${data.amount.toFixed(2)} (Int: ${data.interestRate}%)`;
                        amountClass = 'text-blue-500';
                        amountSign = '';
                        shouldGoToDebtsList = true;
                        
                        if (data.status === 'pending-offer') {
                             hasActiveDebtsOrOffers = true;
                             actionButtonsHtml = `
                                <button class="accept-btn bg-green-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-600 mr-2" data-id="${doc.id}">Aceptar</button>
                                <button class="reject-btn bg-red-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-600" data-id="${doc.id}">Rechazar</button>
                            `;
                            amountDisplay = data.amount.toFixed(2);
                        } else if (data.status === 'accepted') {
                            actionButtonsHtml = `<span class="text-xs text-white bg-green-700 px-2 py-1 rounded-full">Oferta Aceptada</span>`;
                        } else if (data.status === 'rejected') {
                            actionButtonsHtml = `<span class="text-xs text-white bg-gray-500 px-2 py-1 rounded-full">Oferta Rechazada</span>`;
                        }

                    } else if (data.type === 'loan-debt') {
                        // Deuda activa/pagada del deudor (Muestra el botón Pagar si está pendiente)
                        const amountToPay = data.originalAmount * (1 + data.interestRate / 100);
                        const originalAmountDisplay = data.originalAmount.toFixed(2);
                        
                        description = `Deuda con ${data.senderName || 'Desconocido'} (Cap: $${originalAmountDisplay} + Int: ${data.interestRate}%)`;
                        
                        if (data.status === 'pending') {
                            // Deuda activa: Aparece en rojo con signo negativo.
                            amountClass = 'text-red-500';
                            amountSign = '-';
                            amountDisplay = amountToPay.toFixed(2);
                            actionButtonsHtml = `<button class="pay-btn bg-hug-primary text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-blue-600" data-id="${doc.id}" data-sender-transaction-id="${data.senderTransactionId}">Pagar $${amountDisplay}</button>`;
                            shouldGoToDebtsList = true;
                            hasActiveDebtsOrOffers = true;
                        } else {
                            // Deuda pagada: Se neutraliza visualmente la DEUDA
                            amountClass = 'text-gray-500 line-through';
                            amountSign = '';
                            amountDisplay = amountToPay.toFixed(2);
                            actionButtonsHtml = `<span class="text-xs text-white bg-green-500 px-2 py-1 rounded-full">Deuda Pagada</span>`;
                            shouldGoToDebtsList = false; // Una vez pagada, va al historial general para no saturar la lista de deudas.
                        }
                    } else if (data.type === 'loan-received') {
                         description = `Préstamo recibido de ${data.senderName || 'Desconocido'}`; 
                         amountClass = 'text-green-500'; amountSign = '+';
                    } else if (data.type === 'loan-payment-lender-cancellation') {
                        description = `Préstamo cancelado/pagado a ${data.senderName || 'Desconocido'} (historial de pago)`;
                        amountClass = 'text-gray-500 line-through'; amountSign = '-';
                        amountDisplay = data.amount.toFixed(2);
                    }
                    
                    // --- Fin Lógica de Tipos de Transacción ---

                    const dateString = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : 'Fecha desconocida';

                    item.innerHTML = `
                        <div class="${(data.type === 'loan-debt' || data.type === 'loan-offer') && data.status !== 'paid' && data.status !== 'rejected' ? 'font-bold' : ''}">
                            <p class="font-medium">${description}</p>
                            <p class="text-sm text-gray-500">${dateString}</p>
                        </div>
                        <div class="text-right flex flex-col items-end space-y-2">
                            <p class="font-bold ${amountClass}">${amountSign}$${amountDisplay}</p>
                            ${actionButtonsHtml}
                        </div>
                    `;
                    
                    // Separar en listas: Ofertas y Deudas pendientes van a la izquierda
                    if (shouldGoToDebtsList && data.status !== 'paid' && data.status !== 'rejected') {
                        debtsList.appendChild(item);
                    } else {
                        transactionsList.appendChild(item);
                    }
                });

                if (!hasActiveDebtsOrOffers) {
                    debtsList.innerHTML = '<p class="text-gray-500 text-sm text-center">No tienes deudas pendientes ni ofertas de préstamo.</p>';
                }
                
                // --- Añadir Listeners de Acción ---
                
                // Listeners de Pago de Deuda (loan-debt)
                debtsList.querySelectorAll('.pay-btn').forEach(button => {
                    button.addEventListener('click', async () => {
                        const docId = button.dataset.id;
                        // Usamos el docId de la transacción loan-debt para obtener los datos
                        const loanDoc = await getDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/transactions/${docId}`));
                        if (loanDoc.exists()) {
                            // Se pasa el ID de la transacción loan-debt
                            await payLoan(docId, loanDoc.data()); 
                        }
                    });
                });
                
                // Listeners de Aceptar Oferta (loan-offer)
                debtsList.querySelectorAll('.accept-btn').forEach(button => {
                    button.addEventListener('click', async () => {
                        const docId = button.dataset.id;
                        const offerDoc = await getDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/transactions/${docId}`));
                        if (offerDoc.exists()) {
                            await acceptLoanOffer(docId, offerDoc.data());
                        }
                    });
                });
                
                // Listeners de Rechazar Oferta (loan-offer)
                debtsList.querySelectorAll('.reject-btn').forEach(button => {
                    button.addEventListener('click', async () => {
                        const docId = button.dataset.id;
                        const offerDoc = await getDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/transactions/${docId}`));
                        if (offerDoc.exists()) {
                            await rejectLoanOffer(docId, offerDoc.data());
                        }
                    });
                });

                // NUEVOS LISTENERS: Cancelar Préstamo (Prestamista)
                transactionsList.querySelectorAll('.cancel-loan-btn').forEach(button => {
                    button.addEventListener('click', async () => {
                        const loanDocId = button.dataset.id;
                        const recipientId = button.dataset.recipientId;
                        // Se usa confirm() como la única excepción para la confirmación crítica del flujo de negocio
                        if (confirm('¿Estás seguro de que deseas marcar este préstamo como PAGADO? Esto cancelará la deuda activa del deudor y lo habilitará para la puntuación.')) {
                            await cancelLoanByLender(loanDocId, recipientId);
                        }
                    });
                });

                // NUEVOS LISTENERS: Puntuar Deudor (Prestamista)
                transactionsList.querySelectorAll('.score-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const loanDocId = button.dataset.id;
                        const recipientId = button.dataset.recipientId;
                        const recipientName = button.dataset.recipientName;
                        
                        scoreModalRecipientName.textContent = recipientName;
                        scoreModalRecipientId.textContent = recipientId;
                        scoreForm.setAttribute('data-loan-doc-id', loanDocId);
                        scoreForm.setAttribute('data-recipient-id', recipientId);
                        document.querySelectorAll('input[name="rating"]').forEach(radio => radio.checked = false); // Limpiar selección
                        scoreModal.style.display = 'block'; // Muestra el overlay/modal
                    });
                });
            });
        }
    </script>
</body>
</html>
